<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HD현대삼호 E-7 인성검사 (Final v38.1 Fixed)</title>
<script src="https://cdn.tailwindcss.com/3.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{--hd-blue:#002c5f;--hd-green:#009539;--hd-light:#e6eef5;--system-accent:#3b82f6;--glass-bg:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1)}
body{font-family:'Noto Sans KR',sans-serif;user-select:none;-webkit-tap-highlight-color:transparent;background-color:#0f172a;color:#fff;overflow-x:hidden;min-height:100vh}
.font-eng{font-family:'Roboto',sans-serif}
.font-kor{font-family:'Noto Sans KR',sans-serif}
.bg-system-pattern{background:radial-gradient(circle at 20% 30%,rgba(30,58,138,0.4) 0%,transparent 40%),radial-gradient(circle at 80% 70%,rgba(59,130,246,0.3) 0%,transparent 40%),#0f172a;background-attachment:fixed}
.grid-overlay{position:fixed;inset:0;background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
.fade-in{animation:fadeIn 0.8s cubic-bezier(0.16,1,0.3,1)}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.glass-card{background:var(--glass-bg);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid var(--glass-border);box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)}
.btn-premium{background:linear-gradient(135deg,#1e40af 0%,#1d4ed8 100%);box-shadow:0 4px 15px rgba(30,64,175,0.4),inset 0 1px 1px rgba(255,255,255,0.3);transition:all 0.3s cubic-bezier(0.23,1,0.32,1)}
.btn-premium:hover{transform:translateY(-2px);filter:brightness(1.1)}
.btn-premium:active{transform:translateY(1px)}
.system-input{background:rgba(255,255,255,0.03)!important;border:1px solid rgba(255,255,255,0.1)!important;color:#fff!important}
.system-input:focus{background:rgba(255,255,255,0.07)!important;border-color:var(--system-accent)!important}
.lang-btn-premium{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);transition:all 0.2s cubic-bezier(0.4,0,0.2,1)}
.lang-btn-premium.active{background:linear-gradient(135deg,#1e40af 0%,#2563eb 100%);border-color:#60a5fa;box-shadow:0 0 20px rgba(59,130,246,0.4),inset 0 1px 0 rgba(255,255,255,0.2);transform:scale(1.02)}
.lang-btn-premium.active span{color:white!important;opacity:1!important;font-weight:800}
.likert-input:checked+label{background-color:var(--hd-blue);color:white;border-color:var(--hd-blue);transform:scale(1.1);box-shadow:0 0 20px rgba(59,130,246,0.4)}
/* [수정] Likert 척도 정렬 문제 해결을 위한 CSS 추가 */
.likert-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100%;
}
.likert-number-btn {
    flex-shrink: 0;
    margin-bottom: 0.5rem;
}
.likert-label-text {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    text-align: center;
    min-height: 2.5em;
    line-height: 1.2;
    word-break: keep-all;
}

#view-report{display:none;color:#1e293b;background:#525659;overflow:auto}
#view-report.active{display:flex;position:fixed;inset:0;z-index:2000;justify-content:center;align-items:flex-start;padding:40px 20px}
.a4-page{width:210mm;min-width:210mm;min-height:297mm;padding:15mm 20mm;margin:0 auto;background:white;box-shadow:0 10px 30px rgba(0,0,0,0.5);position:relative;box-sizing:border-box;display:flex;flex-direction:column;color:#1e293b;overflow:hidden;transform-origin:top center}
.report-header{border-bottom:3px solid var(--hd-blue);padding-bottom:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-end}
.score-card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center}
.score-card .label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#64748b;font-weight:700;margin-bottom:4px}
.score-card .value{font-size:1.6rem;font-weight:900;color:var(--hd-blue);line-height:1.2;font-family:'Noto Sans KR',sans-serif;word-break:keep-all}
.score-card.highlight-card{background-color:var(--hd-blue)!important;border-color:var(--hd-blue)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.score-card.highlight-card .label{color:#bfdbfe!important}
.score-card.highlight-card .value{color:#ffffff!important}
.section-title{font-size:1.2rem;font-weight:900;color:var(--hd-blue);display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e2e8f0}
.section-title span{background:var(--hd-blue);color:white;width:24px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:14px}
.score-table{width:100%;font-size:0.8rem;border-collapse:separate;border-spacing:0 4px;height:100%}
.score-table th{text-align:left;color:#64748b;font-size:0.7rem;text-transform:uppercase;padding:0 8px;font-weight:800;letter-spacing:0.05em}
.score-table td{background:#fff;padding:2px 8px;border-top:1px solid #f1f5f9;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.score-table tr td:first-child{border-left:1px solid #f1f5f9;border-top-left-radius:6px;border-bottom-left-radius:6px;font-weight:700;color:#334155}
.score-table tr td:last-child{border-right:1px solid #f1f5f9;border-top-right-radius:6px;border-bottom-right-radius:6px}
.grade-badge{display:inline-block;width:22px;height:22px;line-height:22px;text-align:center;border-radius:50%;font-weight:900;font-size:0.8rem;color:white;font-family:'Roboto',sans-serif}
.grade-S{background-color:#4f46e5}
.grade-A{background-color:#3b82f6}
.grade-B{background-color:#10b981}
.grade-C{background-color:#f59e0b}
.grade-D{background-color:#ef4444}
.ai-markdown h2{font-size:1.4rem;font-weight:900;color:var(--hd-blue);margin-top:1.5rem;margin-bottom:1rem;border-bottom:3px solid var(--hd-blue);padding-bottom:6px}
.ai-markdown h3{font-size:1.1rem;font-weight:800;color:#334155;margin-top:1.2rem;margin-bottom:0.6rem;border-left:4px solid var(--system-accent);padding-left:10px}
.ai-markdown p{font-size:0.95rem;line-height:1.7;color:#1e293b;margin-bottom:0.8rem;text-align:justify;word-break:keep-all}
.ai-markdown ul{list-style:none;padding:0;margin-bottom:1rem}
.ai-markdown li{position:relative;padding-left:18px;font-size:0.95rem;color:#334155;margin-bottom:6px;line-height:1.6}
.ai-markdown li::before{content:"•";position:absolute;left:0;color:var(--system-accent);font-weight:bold;font-size:1.2em}
.ai-markdown table{width:100%;border-collapse:collapse;margin-bottom:1.2rem;font-size:0.9rem;border:2px solid #cbd5e1}
.ai-markdown th{background-color:#f8fafc;padding:10px;border:1px solid #94a3b8;font-weight:800;color:var(--hd-blue);text-align:center}
.ai-markdown td{padding:8px 12px;border:1px solid #94a3b8;color:#1e293b;vertical-align:middle}
.ai-markdown strong{color:var(--hd-blue);font-weight:900}
.ai-markdown blockquote{background:#f1f5f9;border-left:4px solid var(--hd-blue);padding:1rem;margin:1rem 0;font-style:italic;color:#475569}
.chart-wrapper{position:relative;height:100%;width:100%}
.filter-btn{padding:0.5rem 1rem;border-radius:0.75rem;font-size:0.75rem;font-weight:800;border:1px solid #e2e8f0;color:#64748b;background:white;transition:all 0.2s}
.filter-btn:hover{background:#f1f5f9}
.filter-btn.active{background:var(--hd-blue);color:white;border-color:var(--hd-blue);box-shadow:0 4px 6px -1px rgba(30,58,138,0.3)}
.fixed-table{table-layout:fixed;width:100%}
/* [수정] 테이블 컬럼 너비 재조정 (ID 우선) */
.col-source{width:8%}
.col-id{width:15%}
.col-name{width:15%}
.col-date{width:12%}
.col-score{width:8%}
.col-rel{width:10%}
.col-grade{width:10%}
.col-action{width:10%}
.ai-markdown table th:first-child,.ai-markdown table td:first-child{width:15%;min-width:60px!important;text-align:center!important;word-break:keep-all;white-space:pre-wrap;vertical-align:middle}
.executive-cover{background:linear-gradient(135deg,#002c5f 0%,#001a38 100%);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;position:relative}
.executive-section{margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}
.executive-summary-box{background:#f1f5f9;border-left:5px solid #002c5f;padding:15px 20px;border-radius:8px;font-size:1rem;line-height:1.7;color:#334155;text-align:justify;margin-bottom:20px;font-weight:500}
@media screen and (min-width:768px) and (max-height:850px){.compact-on-short{padding:1.5rem!important}.text-compact-on-short{font-size:1.5rem!important;margin-bottom:0.5rem!important}.subtext-compact-on-short{font-size:0.875rem!important;margin-top:0.5rem!important;padding-top:0.5rem!important}.likert-compact-on-short{padding-top:0.5rem!important;gap:0.5rem!important}}
@media print {
    @page { size: A4 portrait; margin: 10mm; }
    body > * { display: none !important; }
    #view-report { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; z-index: 9999; }
    #view-report .a4-page { margin: 0; box-shadow: none; page-break-after: always; width: 100% !important; height: auto !important; padding: 10mm 15mm !important; }
    .no-print { display: none !important; }
}
/* Executive Table Styles - Compact for 2 Columns */
.exec-table { width: 100%; border-collapse: collapse; font-size: 10px; }
.exec-table th { background-color: #f1f5f9; color: #475569; font-weight: 800; text-align: center; padding: 4px; border: 1px solid #cbd5e1; }
.exec-table td { border: 1px solid #e2e8f0; padding: 4px; vertical-align: middle; color: #334155; word-break: keep-all; }
.exec-table tr:nth-child(even) { background-color: #f8fafc; }
</style>
</head>
<body class="bg-system-pattern min-h-screen flex flex-col">
<div class="grid-overlay"></div>
<div id="kakaotalk-guide" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;flex-direction:column;align-items:center;justify-content:center;color:white;text-align:center;padding:20px;"><div class="guide-arrow" style="position:absolute;top:20px;right:20px;font-size:3rem;animation:bounceRight 1.5s infinite;">👆</div><div class="max-w-xs"><div class="text-6xl mb-6">⚠️</div><h2 class="text-2xl font-black text-yellow-400 mb-4 break-keep">브라우저 호환성 안내</h2><p class="text-lg font-bold mb-8 leading-relaxed text-white/90 break-keep">카카오톡 인앱 브라우저에서는<br>시스템이 정상 작동하지 않습니다.</p><div class="bg-white/10 rounded-2xl p-6 border border-white/20 text-left space-y-4 mb-8"><div class="flex items-start gap-3"><span class="bg-yellow-400 text-black font-black rounded-full w-6 h-6 flex items-center justify-center text-sm mt-0.5">1</span><span class="font-bold text-sm">우측 상단 <span class="text-yellow-400 text-lg">⋮</span> 또는 <span class="text-yellow-400 text-lg">⋯</span> 버튼 클릭</span></div><div class="flex items-start gap-3"><span class="bg-yellow-400 text-black font-black rounded-full w-6 h-6 flex items-center justify-center text-sm mt-0.5">2</span><span class="font-bold text-sm text-yellow-400">'다른 브라우저로 열기'</span><span class="font-bold text-sm">선택</span></div><div class="flex items-start gap-3"><span class="bg-yellow-400 text-black font-black rounded-full w-6 h-6 flex items-center justify-center text-sm mt-0.5">3</span><span class="font-bold text-sm">Chrome / Safari / Samsung Internet 등으로 접속</span></div></div><button onclick="document.getElementById('kakaotalk-guide').style.display='none'" class="text-sm text-white/40 underline">닫기 (테스트용)</button></div></div>
<div id="qr-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-xl flex items-center justify-center p-4 fade-in z-[3000]" onclick="if(event.target===this)document.getElementById('qr-modal').classList.add('hidden')"><div class="bg-white p-8 rounded-[3rem] shadow-2xl text-center max-w-sm w-full" onclick="event.stopPropagation()"><h3 class="text-2xl font-black text-gray-900 mb-2">SCAN TO START</h3><p class="text-sm text-gray-500 font-bold mb-4">접속 URL 확인 (수정 가능)</p><input type="text" id="qr-url-input" class="w-full bg-slate-100 border border-slate-200 rounded-xl p-3 text-xs font-mono text-slate-600 mb-6 outline-none focus:border-blue-500 transition-colors text-center" placeholder="https://..." oninput="window.generateQRFromInput()"><div class="flex justify-center mb-6"><div id="qrcode-display" class="border-4 border-white shadow-lg rounded-xl overflow-hidden bg-white p-2"></div></div><button onclick="document.getElementById('qr-modal').classList.add('hidden')" class="bg-slate-800 text-white px-8 py-3 rounded-2xl font-black hover:bg-slate-700 transition-colors shadow-lg w-full">닫기</button></div></div>
<div id="confirm-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center p-4 fade-in z-[3000]"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center"><div class="text-5xl mb-5">🗑️</div><h3 class="text-xl font-black text-gray-900 mb-2">삭제 확인</h3><p id="confirm-message" class="text-gray-600 mb-8 text-base break-keep leading-relaxed font-medium">선택한 항목을 정말 삭제하시겠습니까?</p><div class="flex gap-3"><button onclick="document.getElementById('confirm-modal').classList.add('hidden')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-2xl font-bold hover:bg-slate-200 transition-colors">취소</button><button id="confirm-yes-btn" class="flex-1 bg-red-600 text-white py-3 rounded-2xl font-bold shadow-lg hover:bg-red-700 transition-colors">삭제</button></div></div></div>
<script>const GOOGLE_SCRIPT_URL="https://script.google.com/macros/s/AKfycbzDs_3Ri4yyAE5KPKSBZO6H6HQFq8tf9t_j3oa09UbWOjseEkm079iSDsduoppk5wlA/exec";const apiKey="";</script>
<div id="custom-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center p-4 fade-in z-[3000]"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center"><div id="modal-icon" class="text-5xl mb-5">⚠️</div><h3 id="modal-title" class="text-xl font-black text-gray-900 mb-2">시스템 알림</h3><p id="modal-message" class="text-gray-600 mb-8 text-base break-keep leading-relaxed font-medium"></p><button onclick="window.closeModal()" class="bg-blue-900 text-white px-8 py-3 rounded-2xl font-bold w-full shadow-lg">확인</button></div></div>
<div id="app-container" class="flex-grow flex flex-col relative z-10 h-full">
<div class="absolute top-6 right-6 z-50 no-print hidden md:block"><button onclick="window.showAdminLogin()" class="bg-white/10 hover:bg-white/20 text-white/70 hover:text-white font-bold px-4 py-2 text-xs border border-white/20 rounded-full transition-all backdrop-blur-md flex items-center gap-2"><span>🔒</span><span>ADMIN</span></button></div>
<div id="view-home" class="flex-grow flex flex-col items-center justify-center p-6 fade-in min-h-[100dvh]">
<div class="glass-card p-10 md:p-16 rounded-[3rem] max-w-2xl w-full text-center relative overflow-hidden">
<div class="absolute -top-24 -left-24 w-48 h-48 bg-blue-600/20 rounded-full blur-3xl"></div>
<div class="relative z-10 mb-12"><img src="hd_logo.png" alt="HD Hyundai" class="h-14 md:h-20 w-auto mx-auto mb-8 drop-shadow-2xl hover:scale-105 transition-transform duration-500" onerror="this.style.display='none';document.getElementById('fallback-logo').classList.remove('hidden')"><div id="fallback-logo" class="hidden text-white font-black text-3xl md:text-4xl tracking-tighter uppercase font-eng mb-8">HD Hyundai Samho</div><div class="inline-flex items-center gap-3 bg-white/10 px-4 py-1.5 rounded-full border border-white/10 mb-6"><span class="w-2 h-2 rounded-full bg-blue-400 animate-pulse"></span><span class="text-[10px] font-bold tracking-[0.3em] uppercase opacity-70">Automated Assessment System</span></div><h1 class="text-4xl md:text-6xl font-black text-white mb-4 tracking-tighter leading-tight break-keep">E-7 외국인 근로자<br><span class="text-blue-400">인성검사 시스템</span></h1><p class="text-white/40 text-xs md:text-sm font-medium tracking-widest font-eng">V36.4 FINAL (RE-EVAL)</p></div>
<div class="relative z-10 flex flex-col gap-6 max-w-md mx-auto"><button onclick="window.checkUrlAndStart()" class="btn-premium w-full text-white font-black py-6 md:py-8 rounded-[1.5rem] text-2xl md:text-3xl font-eng tracking-tight flex items-center justify-center gap-4 group"><span>START SYSTEM</span><svg class="w-6 h-6 md:w-8 md:h-8 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg></button><div class="flex justify-center gap-3 opacity-60"><span class="bg-white/10 px-4 py-2 rounded-xl text-2xl border border-white/5 cursor-default hover:bg-white/20 transition-colors shadow-sm" title="한국어">🇰🇷</span><span class="bg-white/10 px-4 py-2 rounded-xl text-2xl border border-white/5 cursor-default hover:bg-white/20 transition-colors shadow-sm" title="Tiếng Việt">🇻🇳</span><span class="bg-white/10 px-4 py-2 rounded-xl text-2xl border border-white/5 cursor-default hover:bg-white/20 transition-colors shadow-sm" title="Indonesia">🇮🇩</span><span class="bg-white/10 px-4 py-2 rounded-xl text-2xl border border-white/5 cursor-default hover:bg-white/20 transition-colors shadow-sm" title="English">🇺🇸</span></div></div>
<div class="relative z-10 mt-16 pt-8 border-t border-white/10 flex justify-between items-center text-[10px] md:text-xs text-white/30 font-bold uppercase tracking-widest"><div class="flex items-center gap-2"><span class="text-blue-400">●</span><span>Stored: <span id="stored-count" class="text-white/60">0</span></span></div><div>HD Hyundai Samho</div></div>
</div>
</div>
<div id="view-login" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in min-h-[100dvh]">
<div class="glass-card p-10 md:p-14 rounded-[3rem] max-w-xl w-full relative overflow-hidden">
<div class="absolute -top-10 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl"></div>
<div class="relative z-10 mb-10 text-center"><div class="inline-block bg-blue-500/10 text-blue-400 px-4 py-1 rounded-full text-[10px] font-black tracking-[0.2em] uppercase border border-blue-500/20 mb-4">Verification Layer</div><h2 class="text-3xl md:text-4xl font-black text-white font-eng uppercase tracking-tight">System Access</h2></div>
<div class="relative z-10 space-y-8 max-w-md mx-auto">
<div class="group"><label class="block text-[15px] font-black text-blue-400 mb-2 uppercase tracking-widest ml-1">성명 (Full Name / English)</label><input type="text" id="input-name" class="system-input w-full p-5 rounded-2xl outline-none font-bold text-lg tracking-tight" placeholder="Ex. John Doe"></div>
<div class="group"><label class="block text-[15px] font-black text-blue-400 mb-2 uppercase tracking-widest ml-1">응시번호 (Candidate Number)</label><input type="text" id="input-id" class="system-input w-full p-5 rounded-2xl outline-none font-mono text-lg tracking-widest" placeholder="A1234567"></div>
<div><label class="block text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest ml-1">Localization Protocol</label><div class="grid grid-cols-2 gap-4"><button onclick="window.selectLang('vn')" class="lang-btn-premium border rounded-2xl p-5 flex flex-col items-center gap-2 group" id="btn-vn"><span class="text-3xl">🇻🇳</span><span class="text-xs font-bold text-white/70">Tiếng Việt</span></button><button onclick="window.selectLang('id')" class="lang-btn-premium border rounded-2xl p-5 flex flex-col items-center gap-2 group" id="btn-id"><span class="text-3xl">🇮🇩</span><span class="text-xs font-bold text-white/70">Indonesia</span></button><button onclick="window.selectLang('en')" class="lang-btn-premium border rounded-2xl p-5 flex flex-col items-center gap-2 group" id="btn-en"><span class="text-3xl">🇺🇸</span><span class="text-xs font-bold text-white/70">English</span></button><button onclick="window.selectLang('kr')" class="lang-btn-premium border rounded-2xl p-5 flex flex-col items-center gap-2 group" id="btn-kr"><span class="text-3xl">🇰🇷</span><span class="text-xs font-bold text-white/70">한국어</span></button></div></div>
</div>
<div class="relative z-10 mt-12 flex gap-4 max-w-md mx-auto"><button onclick="window.resetToHome()" class="flex-1 bg-white/5 hover:bg-white/10 text-white/40 hover:text-white font-black py-5 rounded-2xl transition-all border border-white/5 uppercase tracking-widest text-xs">BACK</button><button onclick="window.showGuide()" class="btn-premium flex-[2] text-white font-black py-5 rounded-2xl text-xl font-eng tracking-tight">CONTINUE</button></div>
</div>
</div>
<div id="view-guide" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in min-h-[100dvh]">
<div class="bg-white p-8 md:p-12 rounded-[2.5rem] shadow-2xl max-w-lg w-full text-center border-t-8 border-blue-900 text-slate-800">
<h2 id="guide-title" class="text-3xl font-black text-gray-900 mb-8 font-kor">검사 안내</h2>
<div class="space-y-6 text-left bg-slate-50 p-8 rounded-3xl mb-8 border border-slate-100">
<div class="flex items-center gap-5"><div class="w-14 h-14 rounded-2xl bg-blue-100 flex items-center justify-center text-3xl text-blue-600">⏱️</div><div><p class="text-[10px] text-gray-400 font-black uppercase tracking-widest">Time Limit</p><p id="guide-time" class="font-black text-gray-800 text-2xl font-kor">30분</p></div></div>
<div class="flex items-center gap-5"><div class="w-14 h-14 rounded-2xl bg-indigo-100 flex items-center justify-center text-3xl text-indigo-600">📝</div><div><p class="text-[10px] text-gray-400 font-black uppercase tracking-widest">Questions</p><p id="guide-count" class="font-black text-gray-800 text-2xl font-kor">94문항</p></div></div>
<div class="flex items-start gap-5 pt-6 border-t border-gray-200 mt-4"><div class="w-14 h-14 rounded-2xl bg-red-100 flex items-center justify-center text-3xl text-red-600">💡</div><div><p class="text-[10px] text-red-400 font-black uppercase tracking-widest">Important Notice</p><p id="guide-warn" class="font-bold text-red-600 text-base leading-snug break-keep font-kor">솔직하게 답변하세요.</p></div></div>
</div>
<div class="flex gap-4"><button onclick="window.goToLogin()" class="flex-1 bg-slate-100 text-slate-500 font-black py-5 rounded-2xl font-eng">BACK</button><button onclick="window.startRealTest()" id="guide-btn" class="flex-[2] bg-blue-900 text-white font-black py-5 rounded-2xl shadow-xl text-xl font-eng">START SYSTEM</button></div>
</div>
</div>
<div id="view-assessment" class="hidden flex-grow flex flex-col max-w-6xl mx-auto w-full p-2 md:p-4 fade-in relative h-[100dvh]">
<div class="flex-none pt-1 pb-1 px-1 transition-all">
<div class="bg-white rounded-2xl shadow-lg border border-white/20 px-4 py-3 md:p-4 flex justify-between items-center mb-2 text-slate-800">
<div class="flex items-center"><button onclick="window.prevQuestion()" id="header-btn-prev" class="hidden mr-4 text-blue-600 font-black text-xl hover:text-blue-800 transition-colors p-2 rounded-full hover:bg-blue-50">◀</button><div class="flex flex-col"><span class="text-[9px] md:text-[10px] text-gray-400 font-black uppercase tracking-widest mb-0.5">Progress</span><div class="flex items-baseline gap-1 md:gap-2"><span class="text-2xl md:text-3xl font-black text-blue-900 tabular-nums" id="current-q-num">1</span><span class="text-xs md:text-sm text-gray-400 font-black">/ 94</span></div></div></div>
<div class="bg-blue-50 px-4 py-2 md:px-5 md:py-2 rounded-xl md:rounded-2xl border border-blue-100 flex items-center gap-2 md:gap-3"><span class="animate-pulse text-lg md:text-xl">⏱️</span><span id="timer-display" class="font-mono font-black text-xl md:text-2xl text-blue-900 tabular-nums">30:00</span></div>
</div>
<div class="w-full bg-white/10 rounded-full h-2 md:h-3 overflow-hidden shadow-inner border border-white/5"><div id="progress-bar" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full transition-all duration-300 rounded-full" style="width: 1%"></div></div>
</div>
<div class="flex-1 bg-white rounded-[1.5rem] md:rounded-[2.5rem] shadow-2xl border border-white p-4 md:p-8 lg:p-10 mt-1 mb-2 relative overflow-hidden text-slate-800 flex flex-col justify-between compact-on-short">
<div class="flex-1 w-full relative z-10 flex flex-col justify-center overflow-y-auto no-scrollbar">
<div class="w-full flex flex-col items-center text-center"><h2 id="q-text-native" class="text-xl md:text-3xl lg:text-4xl font-black text-gray-900 mb-2 md:mb-6 leading-snug break-keep tracking-tight text-compact-on-short"></h2><p id="q-text-kr" class="text-gray-400 text-sm md:text-lg border-t-2 border-dashed border-gray-100 pt-2 md:pt-4 mt-2 md:mt-4 inline-block px-4 md:px-8 break-keep font-medium italic subtext-compact-on-short"></p></div>
</div>
<div id="likert-container" class="flex-none pt-2 md:pt-6 grid grid-cols-5 gap-2 md:gap-4 lg:gap-8 select-none max-w-5xl mx-auto w-full relative z-10 items-end likert-compact-on-short"></div>
</div>
<div class="flex-none mt-auto flex gap-4 pb-2 px-2"><div class="flex-grow"></div><button onclick="window.finishAssessment()" id="btn-submit" class="hidden px-8 py-3 md:px-12 md:py-4 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-2xl font-black shadow-xl text-lg md:text-xl flex items-center gap-3"><span>SUBMIT</span></button></div>
</div>
<div id="view-upload" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in min-h-[100dvh]">
<div class="glass-card p-16 rounded-[3rem] shadow-2xl max-w-md w-full text-center">
<div class="relative w-24 h-24 mx-auto mb-10"><div class="absolute inset-0 border-8 border-white/10 rounded-full"></div><div class="absolute inset-0 border-8 border-blue-500 rounded-full border-t-transparent animate-spin"></div></div>
<h2 class="text-2xl md:text-3xl font-black text-white mb-2 tracking-tight">SYSTEM UPLOADING...</h2>
</div>
</div>
<div id="view-thankyou" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in min-h-[100dvh]">
<div class="glass-card p-12 md:p-20 rounded-[4rem] shadow-2xl max-w-lg w-full text-center">
<div class="w-28 h-28 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-10 text-6xl shadow-[0_0_50px_rgba(59,130,246,0.5)] animate-bounce text-white">✅</div>
<h2 class="text-4xl font-black text-white mb-4 tracking-tighter">DATA SUBMITTED</h2>
<div class="flex flex-col gap-4 w-full"><button onclick="window.resetToHome()" class="w-full bg-white text-blue-900 font-black py-6 rounded-3xl hover:bg-slate-100 transition-all text-xl shadow-xl hover:-translate-y-1">FINISH SYSTEM</button><button onclick="window.downloadLocalData()" class="w-full bg-white/10 text-white/70 font-bold py-4 rounded-3xl hover:bg-white/20 transition-all text-sm border border-white/10 flex items-center justify-center gap-2"><span>📂</span> 결과 파일 저장 (전송 실패 시)</button></div>
</div>
</div>
<div id="view-admin-login" class="hidden flex-grow flex flex-col items-center justify-center p-4 fade-in bg-slate-900/90 min-h-[100dvh]">
<div class="bg-white p-12 rounded-[3rem] shadow-2xl max-w-sm w-full text-slate-800">
<h2 class="text-2xl font-black text-gray-900 mb-8 flex items-center gap-3">🔒 SYSTEM ADMIN</h2>
<input type="password" id="admin-pw" class="w-full bg-slate-50 border-2 p-5 rounded-2xl mb-8 text-xl focus:border-blue-900 outline-none font-bold" placeholder="Access Key">
<div class="flex gap-4"><button onclick="window.resetToHome()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-500 py-4 rounded-2xl font-black">BACK</button><button onclick="window.checkAdminPw()" class="flex-2 bg-blue-900 hover:bg-blue-800 text-white py-4 rounded-2xl font-black">LOGIN</button></div>
</div>
</div>
<div id="view-admin-dashboard" class="hidden flex-grow max-w-7xl mx-auto w-full p-4 fade-in h-screen flex flex-col text-slate-800">
<div class="bg-white rounded-[2.5rem] shadow-2xl border border-white overflow-hidden flex flex-col flex-grow">
<div class="p-6 border-b bg-slate-50">
<div class="flex justify-between items-center flex-wrap gap-4 mb-4"><div><div class="flex items-center gap-3"><h2 class="font-black text-2xl text-gray-900 uppercase tracking-tight">Dashboard <span id="db-count-badge" class="bg-blue-600 text-white text-xs px-3 py-1 rounded-full align-middle">0</span></h2></div></div><div class="flex gap-3"><button onclick="window.showQRCode()" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl text-sm font-black shadow-md flex items-center gap-2"><span>📱 QR CODE</span></button><button onclick="window.generateExecutiveReport()" class="bg-blue-800 text-white px-6 py-3 rounded-2xl text-sm font-black shadow-md flex items-center gap-2 hover:bg-blue-900 transition-colors"><span>📊 총괄 보고서</span></button><button onclick="window.deleteSelected()" class="bg-red-600 text-white px-6 py-3 rounded-2xl text-sm font-black shadow-md flex items-center gap-2 hover:bg-red-700 transition-colors"><span>🗑️ 일괄 삭제</span></button><label class="cursor-pointer bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 px-6 py-3 rounded-2xl text-sm font-black shadow-sm transition-all flex items-center gap-2"><span>📂 UPLOAD</span><input type="file" id="excelInput" accept=".xlsx, .xls, .csv, .json" class="hidden" onchange="window.handleFileUpload(this)"></label><button onclick="window.openGoogleSheet()" class="bg-green-600 text-white px-6 py-3 rounded-2xl text-sm font-black shadow-md">SHEET (Backup)</button><button onclick="window.resetToHome()" class="bg-slate-800 text-white px-6 py-3 rounded-2xl text-sm font-black">EXIT</button></div></div>
<div class="flex flex-col md:flex-row gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100">
<div class="relative flex-grow max-w-md flex items-center gap-2">
    <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400">🔍</span>
    <input type="text" id="dashboard-search" oninput="window.handleSearch(this.value)" class="w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-blue-500 font-bold text-sm text-slate-700 placeholder-slate-400" placeholder="이름 또는 수험번호 검색...">
    <!-- [1단계] 날짜 필터링 입력창 추가 -->
    <input type="date" id="dashboard-date" onchange="window.handleDateFilter(this.value)" class="px-4 py-3 rounded-xl border border-slate-200 outline-none focus:border-blue-500 font-bold text-sm text-slate-700" style="min-width: 150px;">
</div>
<div class="flex gap-2 overflow-x-auto pb-1 md:pb-0" id="filter-container"><button onclick="window.setFilter('ALL')" class="filter-btn active" id="filter-ALL">전체</button><button onclick="window.setFilter('S')" class="filter-btn" id="filter-S">S</button><button onclick="window.setFilter('A')" class="filter-btn" id="filter-A">A</button><button onclick="window.setFilter('B')" class="filter-btn" id="filter-B">B</button><button onclick="window.setFilter('C')" class="filter-btn" id="filter-C">C</button><button onclick="window.setFilter('D')" class="filter-btn" id="filter-D">D</button></div>
</div>
</div>
<div class="overflow-auto flex-grow bg-white"><table class="fixed-table text-sm text-left"><thead class="bg-slate-50 border-b text-slate-400 uppercase font-black text-[10px] tracking-widest sticky top-0 shadow-sm z-10"><tr><th class="px-4 py-5 text-center w-[50px]"><input type="checkbox" id="chk-all" onchange="window.toggleAll(this)" class="w-4 h-4 cursor-pointer accent-blue-600"></th><th class="px-4 py-5 col-source cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('source')">Source <span id="sort-arrow-source" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 col-id cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('id')">ID <span id="sort-arrow-id" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 col-name cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('name')">Name <span id="sort-arrow-name" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 col-date cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('date')">Date <span id="sort-arrow-date" class="text-[9px] ml-1">▼</span></th><th class="px-4 py-5 text-center col-score cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('total')">Score <span id="sort-arrow-total" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 text-center col-rel cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('reliability')">Rel <span id="sort-arrow-reliability" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 text-center col-grade cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('decision')">Grade <span id="sort-arrow-decision" class="text-[9px] ml-1"></span></th><th class="px-4 py-5 text-center col-action">View</th></tr></thead><tbody id="dashboard-tbody" class="divide-y divide-slate-100 font-medium"></tbody></table></div>
</div>
</div>
<div id="view-report" class="hidden"><div id="report-content-wrapper" class="transform-origin-top transition-transform"></div></div>
</div>
<script>
// Define utility functions FIRST
window.updateReportScale=function(){const reportWrapper=document.getElementById('report-content-wrapper');if(!reportWrapper)return;const a4=reportWrapper.querySelector('.a4-page');if(!a4)return;const containerWidth=window.innerWidth-40;const a4Width=794;if(containerWidth<a4Width){const scale=containerWidth/a4Width;reportWrapper.style.transform=`scale(${scale})`;reportWrapper.style.marginBottom=`-${(1-scale)*1123}px`;}else{reportWrapper.style.transform='none';reportWrapper.style.marginBottom='0';}};
window.closeReport=function(){document.getElementById('view-report').classList.remove('active');document.getElementById('view-report').classList.add('hidden')};
window.showConfirm=function(m,c){document.getElementById('confirm-message').textContent=m;deleteCallback=c;document.getElementById('confirm-modal').classList.remove('hidden')};
window.getYYYYMMDD=function(d){if(!d)return'-';const o=new Date(d);if(!isNaN(o))return`${o.getFullYear()}.${String(o.getMonth()+1).padStart(2,'0')}.${String(o.getDate()).padStart(2,'0')}`;const m=d.match(/(\d{4})[./-]\s?(\d{1,2})[./-]\s?(\d{1,2})/);return m?`${m[1]}.${m[2].padStart(2,'0')}.${m[3].padStart(2,'0')}`:d.split(' ')[0];};
window.showModal=function(m){document.getElementById('modal-message').innerHTML=m.replace(/\n/g,'<br>');document.getElementById('custom-modal').classList.remove('hidden')};
window.closeModal=function(){document.getElementById('custom-modal').classList.add('hidden')};
// [수정] openGoogleSheet 함수 명시적 정의
window.openGoogleSheet=function(){
    const url = "https://docs.google.com/spreadsheets";
    // window.open이 차단될 경우를 대비한 처리
    const newWindow = window.open(url, "_blank");
    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
        window.showModal("팝업 차단이 감지되었습니다. 팝업 차단을 해제해주세요.");
    }
};

// Functions used in showReport - Defined BEFORE use
function generateReportComment(d) {
    const scores = d.details;
    const diag = d.diagnosis || {};
    let comments = [];
    if (d.decision.includes('S')) comments.push("조직 적응력과 직무 수행 역량이 매우 탁월한 최상위 인재군입니다.");
    else if (d.decision.includes('A')) comments.push("대부분의 역량이 우수하며, 조직 생활에 긍정적인 영향을 미칠 것으로 기대됩니다.");
    else if (d.decision.includes('B1')) comments.push("직무 수행에 필요한 기본적인 소양을 갖추고 있어, 현장 적응에 무리가 없을 것으로 판단됩니다.");
    else if (d.decision.includes('B2')) comments.push("직무 역량이 다소 평이하거나 소극적인 태도가 엿보여, 입사 후 동기 부여가 필요합니다.");
    else if (d.decision.includes('C1')) comments.push("일부 역량에서 위험 요인이 감지되거나 신뢰도에 이슈가 있어, 채용 시 주의 깊은 검토가 필요합니다.");
    else if (d.decision.includes('C2')) comments.push("역량 점수가 현저히 낮아 현장 투입 시 안전 사고 발생 위험이 매우 높습니다. 채용을 재고하거나 강도 높은 사전 교육이 필수적입니다.");
    else if (d.decision.includes('D')) comments.push("조직 부적응 위험이 매우 높거나 불성실한 응답 태도가 발견되어, 현장 투입이 우려됩니다.");
    const sortedKeys = Object.keys(scores).sort((a,b) => scores[b] - scores[a]);
    const topKey = sortedKeys[0];
    const topScore = scores[topKey];
    if (topScore >= 80) {
        if (topKey.startsWith('S')) comments.push("특히 안전 의식이 매우 투철하여, 위험한 현장에서도 수칙을 철저히 준수할 것으로 기대됩니다.");
        else if (topKey.startsWith('C')) comments.push("근태와 책임감이 강점이며, 맡은 업무를 끝까지 완수하려는 성실함이 돋보입니다.");
        else if (topKey.startsWith('R')) comments.push("규정 준수 의식이 높아 관리자의 지시를 잘 따르고 조직 질서를 존중하는 유형입니다.");
        else if (topKey.startsWith('T')) comments.push("동료와의 협력 태도가 우수하여 팀 분위기를 긍정적으로 이끌 가능성이 높습니다.");
        else if (topKey.startsWith('E')) comments.push("감정 조절 능력이 뛰어나고 침착하여, 현장의 돌발 상황에도 유연하게 대처할 것입니다.");
        else if (topKey.startsWith('A')) comments.push("새로운 환경에 대한 적응력이 뛰어나고 업무 습득 속도가 빠를 것으로 예상됩니다.");
    }
    if (diag.sFail) { comments.push("🚨 [주의] 안전 관련 인식 점수가 기준(60점)보다 낮습니다. 현장 배치 전 강도 높은 안전 교육이 필수적입니다."); } 
    else {
        const weakKey = sortedKeys[sortedKeys.length - 1];
        if (scores[weakKey] < 60) {
            if (weakKey.startsWith('T')) comments.push("다만, 단체 생활에서 다소 개인주의적인 성향이 나타날 수 있어 팀워크 배양이 필요합니다.");
            else if (weakKey.startsWith('E')) comments.push("다만, 업무 스트레스에 다소 취약할 수 있으므로 관리자의 세심한 배려와 관심이 요구됩니다.");
            else if (weakKey.startsWith('C')) comments.push("다만, 근태나 시간 관리 측면에서 다소 느슨한 경향이 있어 초반 관리가 필요해 보입니다.");
        }
    }
    return comments.join(" ");
}

function generateReliabilityComment(d) {
    const diag = d.diagnosis || {};
    let msg = "";
    if (d.reliability.includes('V1')) msg = "응답의 일관성이 매우 높고, 자신의 모습을 솔직하게 드러냈습니다. 결과의 신뢰도가 매우 높습니다.";
    else if (d.reliability.includes('V2')) msg = "전반적으로 일관된 응답을 보였으며, 결과 해석에 무리가 없는 양호한 수준입니다.";
    else if (d.reliability.includes('V3')) msg = "일부 응답에서 신뢰도를 저해할 수 있는 요인이 발견되었습니다. ";
    else msg = "응답의 신뢰도가 매우 낮아, 본 결과를 그대로 채용 근거로 활용하기 어렵습니다. ";
    if (d.reliability.includes('V3') || d.reliability.includes('V4') || d.reliability.includes('V5')) {
        let reasons = [];
        if (diag.l1 >= 3) reasons.push("자신을 지나치게 긍정적으로 포장하려는 경향(자기 과시)");
        if (diag.maxC >= 15) reasons.push("특정 번호를 연속적으로 선택한 불성실 응답 패턴");
        if (d.isTooFast || diag.isTimeCut) reasons.push("지나치게 빠른 응답 속도(문항 미숙지 의심)");
        if (reasons.length > 0) { msg += "주요 원인은 **" + reasons.join(", ") + "**입니다. 면접 시 진위 여부를 재확인하시기 바랍니다."; }
    }
    return msg;
}

function calculateAll(name, map) {
    const s = {C1:0,C2:0,R1:0,R2:0,S1:0,S2:0,T1:0,T2:0,E1:0,E2:0,A1:0,A2:0};
    const c = {C1:0,C2:0,R1:0,R2:0,S1:0,S2:0,T1:0,T2:0,E1:0,E2:0,A1:0,A2:0};
    const ansArr = [];
    Object.keys(map).sort((a,b)=>a-b).forEach(k => ansArr.push(map[k]));
    QUESTIONS_FULL.forEach(q => {
        if (map[q.id] !== undefined && q.type !== 'REL') {
            const raw = map[q.id];
            const val = q.rev ? (6 - raw) : raw;
            const norm = ((val - 1) / 4) * 100;
            s[q.type] += norm;
            c[q.type]++;
        }
    });
    const sub = {};
    Object.keys(c).forEach(k => sub[k] = c[k] > 0 ? Math.round(s[k] / c[k]) : 0);
    const main = {
        C: Math.round((sub.C1 + sub.C2) / 2),
        R: Math.round((sub.R1 + sub.R2) / 2),
        S: Math.round((sub.S1 + sub.S2) / 2),
        T: Math.round((sub.T1 + sub.T2) / 2),
        E: Math.round((sub.E1 + sub.E2) / 2),
        A: Math.round((sub.A1 + sub.A2) / 2)
    };
    const total = Math.round((main.C * 0.8 + main.R * 0.8 + main.S * 1.4) / 3);
    const crit = [sub.C1, sub.C2, sub.R1, sub.R2, sub.S1, sub.S2];
    const sFail = sub.S1 < 60 || sub.S2 < 60;
    const failCnt = crit.filter(v => v < 60).length;
    const isCritFail = sFail || (failCnt >= 2);
    let rG = 'V1';
    let l1 = [85, 86, 87, 88].filter(i => map[i] >= 4).length;
    let l2 = [93, 94].filter(i => map[i] === 5).length;
    const kCnt = Object.values(map).filter(v => v === 3).length;
    const fCnt = Object.values(map).filter(v => v === 1 || v === 5).length;
    let maxC = 1, curC = 1;
    if (ansArr.length > 0) {
        let p = ansArr[0];
        for (let i = 1; i < ansArr.length; i++) {
            if (ansArr[i] === p) { curC++; maxC = Math.max(maxC, curC); }
            else { p = ansArr[i]; curC = 1; }
        }
    }
    if (l1 >= 3) rG = 'V2';
    if (l2 >= 1) rG = 'V2';
    if (kCnt >= 65) rG = 'V3';
    if (fCnt >= 75) rG = 'V3';
    if (l1 === 4) rG = 'V3';
    if (l2 === 2) rG = 'V3';
    if (maxC >= 15) rG = 'V3';
    if (maxC >= 30) rG = 'V4';
    if (maxC >= 90) rG = 'V5';
    let dec = 'B1';
    if (rG === 'V4' || rG === 'V5') { dec = 'D'; }
    else if (rG === 'V3') {
        if (total >= 85 && !isCritFail) dec = 'B1';
        else dec = 'C';
    }
    else if (isCritFail) { dec = 'C'; }
    else if (total >= 91 && (rG === 'V1' || rG === 'V2') && main.R >= 88 && main.S >= 88 && !isCritFail) { dec = 'S'; }
    else if (total >= 81 && (rG === 'V1' || rG === 'V2')) { dec = 'A'; }
    else if (total < 66) { dec = 'B2'; }
    else { dec = 'B1'; }

    if (dec === 'C') {
        if (total < 50) dec = 'C2';
        else dec = 'C1';
    }

    const gMap = { S: '최우수 (S)', A: '우수 (A)', B1: '보통 (B1)', B2: '보통 (B2)', C1: '주의 (C1)', C2: '위험 (C2)', D: '부적합 (D)' };
    const rMap = { V1: '높음 (V1)', V2: '보통 (V2)', V3: '주의 (V3)', V4: '낮음 (V4)', V5: '매우 낮음 (V5)' };
    return {
        name, total, reliability: rMap[rG] || rG, decision: gMap[dec] || dec, details: sub, mainDetails: main, minScore: Math.min(...crit), answers: map,
        diagnosis: { l1: l1, l2: l2, maxC: maxC, sFail: sFail, failCnt: failCnt }
    };
}

async function generateAIAnalysis(d) {
    const btn = document.getElementById('btn-ai-generate');
    const con = document.getElementById('ai-result-container');
    if (!btn || !con) return;
    btn.innerHTML = '✨ AI 분석 중... (약 10초)';
    btn.disabled = true;
    btn.classList.add('opacity-50');
    try {
        let sRes = "";
        if (d.answers) {
            const items = [];
            Object.entries(d.answers).forEach(([qid, v]) => {
                const q = QUESTIONS_FULL.find(q => q.id == qid);
                if (q && (v == 1 || v == 5) && q.type !== 'REL') {
                    items.push(`- 문항 ${q.id} [${q.type}] "${q.kr}": ${v}점 (${v==1?'전혀아님':'매우그렇다'})`);
                }
            });
            if (items.length > 0) sRes = "\n[주요 응답 패턴 (1점/5점 문항)]\n" + items.join("\n");
        }
        
        const prompt = `
당신은 HD현대삼호의 외국인 인력 채용 전문가이자 인사 평가관입니다. 제공된 후보자의 인성검사 결과 데이터와 **주요 문항별 응답 내역**을 바탕으로 채용 면접관과 현장 관리자가 참고할 수 있는 **구조화된 심층 분석 보고서**를 작성하십시오. 

후보자는 조선업 E-7-3 용접공, 전기공, 도장공 대상이며, 외국인 생산직 특성을 고려해야 합니다.

**[분석 지침]**
1. **데이터 기반 추론:** 단순히 "점수가 낮다"고 하지 말고, **제공된 [주요 응답 패턴]의 구체적인 문항 내용**을 근거로 들어 설명하십시오. 
    - 예시: "안전 점수가 낮은데, 특히 '보호구 착용이 불편하면 안 써도 된다'는 문항에 동의한 것으로 보아..."
2. **현장 밀착형 조언:** 추상적인 조언 대신, 작업 현장에서 발생할 수 있는 구체적인 시나리오(오작동, 다툼, 지각 등)를 예측하십시오.
3. **형식 및 가독성 준수:** - 반드시 아래 [출력 양식] 마크다운 포맷을 그대로 따르십시오.
    - **표의 '구분' 열은 텍스트가 세로로 찌그러지지 않도록, 2~4글자 단위로 적절히 줄바꿈(<br>) 태그를 넣어 작성하십시오. (예: '강점<br>요인', '작업<br>배치 시')**

**[후보자 기본 정보]**
- 성명: ${d.name} (${d.id})
- 응시일자: ${d.date || 'N/A'}
- 종합 점수: ${d.total}점 (등급: ${d.decision})
- 신뢰도: ${d.reliability}

**[세부 역량 점수]**
(각 영역 100점 만점 환산 점수)
| 영역 | 항목 | 점수 | 상태 |
|---|---|---|---|
| 근태/책임 | 근태(C1) | ${d.details.C1} | ${d.details.C1 >= 80 ? '우수' : d.details.C1 >= 60 ? '보통' : '주의'} |
| | 책임(C2) | ${d.details.C2} | ${d.details.C2 >= 80 ? '우수' : d.details.C2 >= 60 ? '보통' : '주의'} |
| 규범/정직 | 규정(R1) | ${d.details.R1} | ${d.details.R1 >= 80 ? '우수' : d.details.R1 >= 60 ? '보통' : '주의'} |
| | 정직(R2) | ${d.details.R2} | ${d.details.R2 >= 80 ? '우수' : d.details.R2 >= 60 ? '보통' : '주의'} |
| 조직/협력 | 협력(T1) | ${d.details.T1} | ${d.details.T1 >= 80 ? '우수' : d.details.T1 >= 60 ? '보통' : '주의'} |
| | 갈등(T2) | ${d.details.T2} | ${d.details.T2 >= 80 ? '우수' : d.details.T2 >= 60 ? '보통' : '주의'} |
| 정서/안전 | 감정(E1) | ${d.details.E1} | ${d.details.E1 >= 80 ? '우수' : d.details.E1 >= 60 ? '보통' : '주의'} |
| | 안전(S1) | ${d.details.S1} | ${d.details.S1 >= 80 ? '우수' : d.details.S1 >= 60 ? '보통' : '주의'} |
| | 위험(S2) | ${d.details.S2} | ${d.details.S2 >= 80 ? '우수' : d.details.S2 >= 60 ? '보통' : '주의'} |
| 적응/학습 | 학습(A1) | ${d.details.A1} | ${d.details.A1 >= 80 ? '우수' : d.details.A1 >= 60 ? '보통' : '주의'} |
| | 적응(A2) | ${d.details.A2} | ${d.details.A2 >= 80 ? '우수' : d.details.A2 >= 60 ? '보통' : '주의'} |

${sRes}

**[출력 양식]**
## 1. 📋 종합 평가 요약
(후보자의 전반적인 인성 수준과 조직 적합성을 3줄 내외로 요약. 총점이 높으면 긍정적, 낮으면 우려점 위주로 서술. 신뢰도가 낮으면 그 원인을 문항 패턴에서 찾아 언급.)

## 2. 📊 역량 상세 분석
| 구분 | 분석 내용 |
| :---: | :----- |
| **강점<br>요인**| (점수가 높은 영역을 언급하되, 해당 영역의 **구체적인 문항(긍정 응답)**을 예시로 들어 어떤 행동 특성이 기대되는지 서술) |
| **보완<br>필요**| (점수가 낮은 영역이나 **부정적인 응답을 한 문항**을 콕 집어서 언급하고, 발생 가능한 리스크 서술. 없으면 '특이사항 없음') |

## 3. 🏗️ 현장 관리 가이드 (직/반장용)
| 구분 | 관리 조언 |
| :---: | :----- |
| **작업<br>배치 시**| (안전/규범 점수 및 관련 문항 응답을 고려하여 위험 작업 배치 여부 조언)|
| **소통<br>및 지시**| (협력/적응 점수를 고려한 의사소통 방식 제안)|
| **근태<br>관리**| (근태/책임 점수와 관련 문항 답변을 토대로 한 관리 포인트)|

## 4. 💬 심층 면접관을 위한 질문 가이드
| 영역 | 핵심 질문 (Probe Question) | 분석 목적 |
| :---: | :--- | :--- |
| **(취약영역1)** | "(취약한 부분과 관련된 상황 제시형 질문... 예: 안전장비가 불편할 때 어떻게 하겠는가?)" | (질문 의도) |
| **(취약영역2)** | "(또 다른 취약점 관련 질문)" | (질문 의도) |
`;
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        if (!data.candidates || !data.candidates[0]) { throw new Error(data.error?.message || "API 응답 오류"); }
        con.innerHTML = `<div class="a4-page ai-report-page" style="margin-top:20px;height:auto!important;min-height:297mm;overflow:visible!important;"><div class="report-header"><div><img src="hd_logo.png" style="height:32px;margin-bottom:4px;" onerror="this.style.display='none'"><div class="text-3xl font-black text-[#002c5f] font-eng uppercase">인성검사 심층 분석 보고서</div></div><div class="text-right"><div class="text-xs text-gray-400 font-bold uppercase tracking-widest">Confidential Report</div><div class="text-lg font-black text-gray-800 font-kor">${d.name} <span class="text-base text-gray-500 font-bold">(${d.id})</span></div><div class="text-lg font-bold text-gray-500 font-eng mt-1">${getYYYYMMDD(d.date||new Date())}</div></div></div><div class="bg-slate-50 border border-slate-200 rounded-2xl p-8 ai-markdown flex-grow">${marked.parse(data.candidates[0].content.parts[0].text)}</div><div class="mt-4 pt-4 border-t border-gray-100 text-center text-[10px] text-gray-300 font-black uppercase tracking-[0.4em]">HD HYUNDAI SAMHO </div></div>`;
        btn.style.display = 'none';
        updateReportScale(); // AI 분석 후 리사이징
    } catch (e) {
        console.error(e);
        btn.innerHTML = '생성 실패 (재시도)';
        btn.disabled = false;
        btn.classList.remove('opacity-50');
        alert("AI 분석 생성 중 오류가 발생했습니다: " + e.message);
    }
}

// Global variables
var GUIDE_TEXTS={kr:{title:"검사 안내",timeLabel:"Time Limit",timeVal:"30분",countLabel:"Questions",countVal:"94문항",warnLabel:"Important Notice",warnVal:"솔직하게 답변하세요.<br>답변이 일관되지 않으면 불합격 처리될 수 있습니다.",btn:"START SYSTEM"},vn:{title:"Hướng dẫn kiểm tra",timeLabel:"Thời gian",timeVal:"30 phút",countLabel:"Câu hỏi",countVal:"94 câu",warnLabel:"Lưu ý quan trọng",warnVal:"Hãy trả lời trung thực.<br>Nếu câu trả lời không nhất quán, bạn có thể bị trượt.",btn:"BẮT ĐẦU"},id:{title:"Panduan Tes",timeLabel:"Waktu",timeVal:"30 menit",countLabel:"Pertanyaan",countVal:"94 butir",warnLabel:"Pemberitahuan Penting",warnVal:"Jawablah dengan jujur.<br>Jika jawaban tidak konsisten, Anda mungkin gagal.",btn:"MULAI SISTEM"},en:{title:"Test Guide",timeLabel:"Time Limit",timeVal:"30 min",countLabel:"Questions",countVal:"94 items",warnLabel:"Important Notice",warnVal:"Please answer honestly.<br>Inconsistent answers may result in failure.",btn:"START SYSTEM"}};
// [개선된 문항 적용] 외국인 이해도 및 번역 정확성을 고려하여 문장을 다듬었습니다.
var QUESTIONS_FULL = [
  {id:1,type:'C1',rev:false,kr:"나는 작업 시작 시간보다 일찍 도착해서 준비한다.",en:"I arrive earlier than the start time to prepare for work.",vn:"Tôi đến sớm hơn giờ làm việc để chuẩn bị.",ind:"Saya datang lebih awal dari jam kerja untuk bersiap-siap."},
  {id:2,type:'C1',rev:true,kr:"나는 오늘 해야 할 일을 내일로 미룰 때가 있다.",en:"I sometimes put off today's work until tomorrow.",vn:"Đôi khi tôi trì hoãn công việc của hôm nay sang ngày mai.",ind:"Terkadang saya menunda pekerjaan hari ini hingga besok."},
  {id:3,type:'C1',rev:false,kr:"일하는 시간에는 개인적인 휴대폰 사용을 하지 않으려 한다.",en:"I try not to use my personal phone during working hours.",vn:"Tôi cố gắng không sử dụng điện thoại cá nhân trong giờ làm việc.",ind:"Saya berusaha tidak menggunakan ponsel pribadi selama jam kerja."},
  {id:4,type:'C1',rev:false,kr:"정해진 시간 안에 일을 끝내기 위해 서둘러서 일한다.",en:"I maintain a pace to finish tasks within the designated hours.",vn:"Tôi làm việc khẩn trương để hoàn thành công việc trong thời gian quy định.",ind:"Saya bekerja dengan cepat untuk menyelesaikan tugas tepat waktu."},
  {id:5,type:'C1',rev:true,kr:"피곤하면 일에 집중하지 못하고 다른 짓을 할 때가 있다.",en:"When I am tired, I lose focus and do non-work related things.",vn:"Khi mệt mỏi, tôi mất tập trung và làm việc riêng.",ind:"Saat lelah, saya kehilangan fokus dan melakukan hal yang tidak penting."},
  {id:6,type:'C1',rev:false,kr:"오늘 할 일을 메모지나 달력에 적어서 관리한다.",en:"I write down tasks on a note or calendar to manage them.",vn:"Tôi ghi chép công việc cần làm vào giấy nhớ hoặc lịch để quản lý.",ind:"Saya mencatat tugas di kertas catatan atau kalender untuk mengelolanya."},
  {id:7,type:'C1',rev:false,kr:"여러 일이 겹치면 중요한 순서대로 처리한다.",en:"When I have multiple tasks, I handle them in order of importance.",vn:"Khi có nhiều việc, tôi xử lý theo thứ tự quan trọng.",ind:"Ketika ada banyak tugas, saya mengerjakannya sesuai urutan prioritas."},
  {id:8,type:'C2',rev:false,kr:"내 일은 중간에 멈추지 않고 끝까지 마친다.",en:"I finish my work until the end without stopping halfway.",vn:"Tôi hoàn thành công việc của mình đến cùng mà không dừng lại giữa chừng.",ind:"Saya menyelesaikan pekerjaan saya sampai tuntas tanpa berhenti di tengah jalan."},
  {id:9,type:'C2',rev:true,kr:"작은 실수는 관리자에게 말하지 않아도 된다고 생각한다.",en:"I think small mistakes don't need to be reported to the manager.",vn:"Tôi nghĩ những lỗi nhỏ không cần báo cáo với quản lý.",ind:"Saya pikir kesalahan kecil tidak perlu dilaporkan kepada manajer."},
  {id:10,type:'C2',rev:false,kr:"작업이 끝나면 결과가 잘 되었는지 다시 확인한다.",en:"After finishing work, I re-check if the result is correct.",vn:"Sau khi làm xong, tôi kiểm tra lại xem kết quả có tốt không.",ind:"Setelah selesai bekerja, saya memeriksa kembali apakah hasilnya baik."},
  {id:11,type:'C2',rev:false,kr:"지시 내용이 확실하지 않으면 다시 물어본다.",en:"If instructions are unclear, I ask again.",vn:"Nếu chỉ thị không rõ ràng, tôi sẽ hỏi lại.",ind:"Jika instruksi tidak jelas, saya akan bertanya lagi."},
  {id:12,type:'C2',rev:false,kr:"내 실수로 문제가 생기면 내가 책임지고 해결한다.",en:"If a problem occurs due to my mistake, I take responsibility to solve it.",vn:"Nếu có vấn đề do lỗi của tôi, tôi sẽ chịu trách nhiệm giải quyết.",ind:"Jika terjadi masalah akibat kesalahan saya, saya bertanggung jawab menyelesaikannya."},
  {id:13,type:'C2',rev:false,kr:"품질 기준이 높아도 맞추기 위해 노력한다.",en:"Even if quality standards are high, I try hard to meet them.",vn:"Dù tiêu chuẩn chất lượng cao, tôi vẫn cố gắng đáp ứng.",ind:"Meskipun standar kualitas tinggi, saya berusaha keras memenuhinya."},
  {id:14,type:'C2',rev:true,kr:"일이 잘 안 되면 대충 마무리할 때가 있다.",en:"When work doesn't go well, I sometimes finish it roughly.",vn:"Khi công việc không thuận lợi, đôi khi tôi làm qua loa.",ind:"Saat pekerjaan tidak lancar, terkadang saya menyelesaikannya dengan asal-asalan."},
  {id:15,type:'R1',rev:false,kr:"나의 생각보다 회사의 규칙이 더 중요하다.",en:"Company rules are more important than my personal thoughts.",vn:"Quy định của công ty quan trọng hơn suy nghĩ cá nhân của tôi.",ind:"Peraturan perusahaan lebih penting daripada pemikiran pribadi saya."},
  {id:16,type:'R1',rev:true,kr:"급하면 안전 규칙을 지키지 않아도 된다고 생각한다.",en:"I think safety rules can be skipped if I am in a hurry.",vn:"Tôi nghĩ nếu gấp thì không cần tuân thủ quy tắc an toàn.",ind:"Saya pikir jika terburu-buru, aturan keselamatan boleh tidak diikuti."},
  {id:17,type:'R1',rev:false,kr:"일하는 중에는 내 자리를 비우지 않으려 한다.",en:"I try not to leave my designated spot while working.",vn:"Tôi cố gắng không rời khỏi vị trí khi đang làm việc.",ind:"Saya berusaha tidak meninggalkan tempat saya saat bekerja."},
  {id:18,type:'R1',rev:false,kr:"들어가지 말라는 곳은 이유를 몰라도 절대 들어가지 않는다.",en:"I never enter restricted areas even if I don't know the reason.",vn:"Tôi tuyệt đối không vào khu vực cấm dù không biết lý do.",ind:"Saya tidak pernah masuk ke area terlarang meskipun saya tidak tahu alasannya."},
  {id:19,type:'R1',rev:false,kr:"관리자가 없어도 규칙을 잘 지킨다.",en:"I follow rules well even without a manager watching.",vn:"Tôi tuân thủ quy tắc ngay cả khi không có quản lý.",ind:"Saya mematuhi aturan dengan baik meskipun tidak ada manajer."},
  {id:20,type:'R1',rev:false,kr:"일이 복잡해도 정해진 순서대로 한다.",en:"Even if the work is complex, I follow the set order.",vn:"Dù công việc phức tạp, tôi vẫn làm theo trình tự quy định.",ind:"Meskipun pekerjaannya rumit, saya mengikuti urutan yang ditetapkan."},
  {id:21,type:'R1',rev:true,kr:"다른 사람이 규칙을 어기면, 나도 따라서 어기고 싶어진다.",en:"If others break the rules, I feel like breaking them too.",vn:"Nếu người khác vi phạm quy tắc, tôi cũng muốn làm theo.",ind:"Jika orang lain melanggar aturan, saya juga ingin ikut melanggarnya."},
  {id:22,type:'R2',rev:false,kr:"실수나 사고는 즉시 거짓 없이 보고해야 한다.",en:"Mistakes or accidents must be reported immediately and honestly.",vn:"Sai sót hoặc tai nạn phải được báo cáo ngay lập tức và trung thực.",ind:"Kesalahan atau kecelakaan harus dilaporkan segera dan jujur."},
  {id:23,type:'R2',rev:false,kr:"회사의 물건을 개인적으로 가져가거나 쓰지 않는다.",en:"I do not take or use company items for personal use.",vn:"Tôi không lấy hoặc sử dụng đồ của công ty cho mục đích cá nhân.",ind:"Saya tidak mengambil atau menggunakan barang perusahaan untuk keperluan pribadi."},
  {id:24,type:'R2',rev:false,kr:"거짓말로 작업 기록을 꾸며 달라는 부탁은 거절한다.",en:"I refuse requests to falsify documents.",vn:"Tôi từ chối yêu cầu làm giả tài liệu.",ind:"Saya menolak permintaan untuk memalsukan dokumen."},
  {id:25,type:'R2',rev:true,kr:"친한 동료가 잘못하면 모른 척 넘어갈 때가 있다.",en:"If a close colleague does wrong, I sometimes pretend not to know.",vn:"Nếu đồng nghiệp thân thiết làm sai, đôi khi tôi giả vờ không biết.",ind:"Jika rekan dekat berbuat salah, terkadang saya pura-pura tidak tahu."},
  {id:26,type:'R2',rev:false,kr:"내가 잘못했을 때는 인정하고 사과한다.",en:"When I do wrong, I admit it and apologize.",vn:"Khi tôi làm sai, tôi thừa nhận và xin lỗi.",ind:"Ketika saya salah, saya mengakuinya dan meminta maaf."},
  {id:27,type:'R2',rev:false,kr:"다른 사람이 한 일을 내가 했다고 하지 않는다.",en:"I do not claim credit for what others have done.",vn:"Tôi không nhận công lao về việc người khác đã làm.",ind:"Saya tidak mengklaim pekerjaan orang lain sebagai pekerjaan saya."},
  {id:28,type:'R2',rev:true,kr:"결과가 좋으면 과정은 보고하지 않아도 된다고 생각한다.",en:"I think if the result is good, the process doesn't need reporting.",vn:"Tôi nghĩ nếu kết quả tốt thì không cần báo cáo quá trình.",ind:"Saya pikir jika hasilnya bagus, prosesnya tidak perlu dilaporkan."},
  {id:29,type:'T1',rev:false,kr:"동료가 힘들어 보이면 내가 먼저 도와준다.",en:"If a colleague looks tired, I help them first.",vn:"Nếu đồng nghiệp có vẻ vất vả, tôi sẽ giúp đỡ trước.",ind:"Jika rekan kerja terlihat kesulitan, saya akan membantunya terlebih dahulu."},
  {id:30,type:'T1',rev:false,kr:"새로운 직원이 오면 먼저 다가가서 일을 알려준다.",en:"When a new employee comes, I approach them first to teach the work.",vn:"Khi có nhân viên mới, tôi chủ động đến hướng dẫn công việc.",ind:"Saat ada karyawan baru, saya mendekatinya dulu untuk mengajari pekerjaan."},
  {id:31,type:'T1',rev:false,kr:"팀의 목표를 위해서라면 내 의견을 양보할 수 있다.",en:"I can give up my opinion for the team's goal.",vn:"Tôi có thể nhường ý kiến của mình vì mục tiêu của nhóm.",ind:"Saya bisa mengalah demi tujuan tim."},
  {id:32,type:'T1',rev:true,kr:"다른 사람을 돕는 것이 귀찮거나 힘들 때가 있다.",en:"Helping others is sometimes annoying or burdensome.",vn:"Đôi khi việc giúp đỡ người khác thật phiền phức hoặc mệt mỏi.",ind:"Terkadang membantu orang lain terasa merepotkan atau membebani."},
  {id:33,type:'T1',rev:false,kr:"모르는 것이 있으면 미루지 않고 바로 물어본다.",en:"If I don't know something, I ask immediately without delay.",vn:"Nếu không biết, tôi hỏi ngay chứ không trì hoãn.",ind:"Jika tidak tahu, saya langsung bertanya tanpa menunda."},
  {id:34,type:'T1',rev:false,kr:"동료가 무엇을 잘하고 무엇을 못하는지 파악하려고 한다.",en:"I try to understand what my colleagues are good and bad at.",vn:"Tôi cố gắng nắm bắt xem đồng nghiệp giỏi와 kém điểm nào.",ind:"Saya mencoba memahami kelebihan dan kekurangan rekan kerja."},
  {id:35,type:'T1',rev:false,kr:"동료가 일을 잘하면 칭찬해 준다.",en:"I praise my colleagues when they do a good job.",vn:"Tôi khen ngợi khi đồng nghiệp làm tốt.",ind:"Saya memuji rekan kerja jika mereka bekerja dengan baik."},
  {id:36,type:'T2',rev:false,kr:"상대의 의견이 나와 달라도 끝까지 듣는다.",en:"I listen to others until the end even if their opinion is different.",vn:"Tôi lắng nghe đến cùng dù ý kiến đối phương khác tôi.",ind:"Saya mendengarkan sampai selesai meskipun pendapat orang lain berbeda."},
  {id:37,type:'T2',rev:true,kr:"화가 나면 얼굴 표정에 바로 나타난다.",en:"When I am angry, it shows immediately on my face.",vn:"Khi tức giận, nó hiện ngay lên nét mặt tôi.",ind:"Jika saya marah, itu langsung terlihat di wajah saya."},
  {id:38,type:'T2',rev:false,kr:"동료와 문제가 생기면 해결 방법부터 찾는다.",en:"If I have a problem with a colleague, I look for a solution first.",vn:"Nếu có vấn đề với đồng nghiệp, tôi tìm cách giải quyết trước.",ind:"Jika ada masalah dengan rekan kerja, saya mencari solusinya dulu."},
  {id:39,type:'T2',rev:false,kr:"동료 험담(나쁜 말)을 할 때 같이 맞장구치지 않는다.",en:"I do not join in when others speak ill of colleagues.",vn:"Tôi không hùa theo khi người khác nói xấu đồng nghiệp.",ind:"Saya tidak ikut-ikutan saat orang lain menjelekkan rekan kerja."},
  {id:40,type:'T2',rev:false,kr:"내가 잘못했을 때는 변명하지 않고 바로 사과한다.",en:"When I am wrong, I apologize immediately without excuses.",vn:"Khi tôi sai, tôi xin lỗi ngay mà không biện hộ.",ind:"Saat saya salah, saya langsung minta maaf tanpa alasan."},
  {id:41,type:'T2',rev:true,kr:"기분이 나쁘면 남에게 상처 주는 말을 할 때가 있다.",en:"When I feel bad, I sometimes say hurtful things to others.",vn:"Khi tâm trạng tồi tệ, đôi khi tôi nói lời gây tổn thương cho người khác.",ind:"Saat suasana hati buruk, terkadang saya mengucapkan kata-kata yang menyakiti orang lain."},
  {id:42,type:'T2',rev:false,kr:"분위기가 나쁘면 말을 줄이고 상황을 살핀다.",en:"If the atmosphere is bad, I speak less and observe the situation.",vn:"Nếu bầu không khí không tốt, tôi nói ít lại와관 sát tình hình.",ind:"Jika suasananya buruk, saya mengurangi bicara dan mengamati situasi."},
  {id:43,type:'E1',rev:false,kr:"꾸중을 들어도 기분이 금방 풀린다.",en:"Even if I am scolded, I feel better quickly.",vn:"Dù bị mắng, tôi cũng nhanh chóng lấy lại tinh thần.",ind:"Meskipun dimarahi, perasaan saya cepat membaik."},
  {id:44,type:'E1',rev:true,kr:"작은 일에도 쉽게 화가 난다.",en:"I get angry easily even at small things.",vn:"Tôi dễ nổi giận vì những chuyện nhỏ.",ind:"Saya mudah marah bahkan karena hal 작은."},
  {id:45,type:'E1',rev:false,kr:"긴장되는 상황에서도 침착하려고 노력한다.",en:"I try to stay calm even in tense situations.",vn:"Tôi cố gắng giữ bình tĩnh trong tình huống căng thẳng.",ind:"Saya berusaha tetap tenang dalam situasi tegang."},
  {id:46,type:'E1',rev:false,kr:"예민한 사람들과 함께 있어도 내 기분을 잘 관리한다.",en:"I manage my mood well even when with sensitive people.",vn:"Tôi quản lý tốt cảm xúc의 mình dù ở cùng người nhạy cảm.",ind:"Saya menjaga suasana hati에 baik meskipun bersama orang sensitif."},
  {id:47,type:'E1',rev:true,kr:"기분이 나쁘면 일에 집중하기 어렵다.",en:"It is hard to concentrate on work when I feel bad.",vn:"Khó tập trung làm việc khi tâm trạng không tốt.",ind:"Sulit berkonsentrasi kerja saat perasaan tidak enak."},
  {id:48,type:'E1',rev:false,kr:"다툼이 생기면 내 표정부터 관리한다.",en:"When a fight occurs, I control my facial expression first.",vn:"Khi có tranh cãi, tôi quản lý biểu cảm của mình trước.",ind:"Jika terjadi pertengkaran, saya mengontrol ekspresi wajah saya dulu."},
  {id:49,type:'E1',rev:false,kr:"내 기분이 안 좋아도 일에는 영향이 없도록 한다.",en:"I make sure my bad mood doesn't affect my work.",vn:"Tôi không để tâm trạng tồi tệ ảnh hưởng đến công việc.",ind:"Saya memastikan suasana hati buruk saya tidak mempengaruhi pekerjaan."},
  {id:50,type:'E2',rev:false,kr:"일이 많아도 당황하지 않고 하나씩 순서대로 한다.",en:"Even with lots of work, I don't panic and do it one by one.",vn:"Dù nhiều việc, tôi không hoảng hốt mà làm từng việc theo thứ tự.",ind:"Meskipun banyak kerjaan, saya tidak panik dan mengerjakannya satu per satu."},
  {id:51,type:'E2',rev:false,kr:"실수하면 다시는 같은 실수를 하지 않으려고 노력한다.",en:"If I make a mistake, I try not to make the same mistake again.",vn:"Nếu mắc lỗi, tôi cố gắng không lặp lại lỗi đó.",ind:"Jika saya berbuat salah, saya berusaha untuk tidak mengulangi kesalahan yang sama."},
  {id:52,type:'E2',rev:true,kr:"일이 잘 안 풀리면 그만두고 싶을 때가 있다.",en:"When work doesn't go well, I sometimes want to quit.",vn:"Khi công việc không suôn sẻ, đôi khi tôi muốn bỏ cuộc.",ind:"Saat pekerjaan tidak lancar, terkadang saya ingin berhenti."},
  {id:53,type:'E2',rev:false,kr:"힘들어도 끝까지 책임지고 한다.",en:"Even if it's hard, I take responsibility until the end.",vn:"Dù khó khăn, tôi vẫn chịu trách nhiệm đến cùng.",ind:"Meskipun sulit, saya bertanggung jawab sampai akhir."},
  {id:54,type:'E2',rev:false,kr:"스트레스를 받으면 잠시 쉬고 다시 일에 집중한다.",en:"When stressed, I rest a bit and focus on work again.",vn:"Khi căng thẳng, tôi nghỉ một lát rồi tập trung lại vào công việc.",ind:"Saat stres, saya istirahat sebentar lalu fokus kerja lagi."},
  {id:55,type:'E2',rev:true,kr:"몸이 피곤하면 일을 계속하기 어렵다.",en:"It is hard to continue working when my body is tired.",vn:"Khó tiếp tục làm việc khi cơ thể mệt mỏi.",ind:"Sulit trus bekerja saat badan lelah."},
  {id:56,type:'E2',rev:false,kr:"먼 미래를 위해 지금의 고생을 참을 수 있다.",en:"I can endure current hardships for the distant future.",vn:"Tôi có thể chịu đựng vất vả hiện tại vì tương lai xa.",ind:"Saya bisa menahan kesulitan saat ini demi masa depan."},
  {id:57,type:'S1',rev:false,kr:"보호구가 불편해도 반드시 착용한다.",en:"I always wear safety gear even if it is uncomfortable.",vn:"Dù đồ bảo hộ bất tiện, tôi vẫn nhất định phải mặc.",ind:"Saya selalu memakai alat pelindung meskipun tidak nyaman."},
  {id:58,type:'S1',rev:true,kr:"짧은 시간 작업할 때는 보호구를 안 써도 된다고 생각한다.",en:"I think safety gear is not needed for short tasks.",vn:"Tôi nghĩ làm việc thời gian ngắn thì không cần dùng đồ bảo hộ.",ind:"Saya pikir tidak perlu pakai alat pelindung untuk pekerjaan singkat."},
  {id:59,type:'S1',rev:false,kr:"일의 속도보다 안전 규칙이 더 중요하다.",en:"Safety rules are more important than work speed.",vn:"Quy tắc an toàn quan trọng hơn tốc độ làm việc.",ind:"Aturan keselamatan lebih penting daripada kecepatan kerja."},
  {id:60,type:'S1',rev:false,kr:"안전교육 내용을 떠올리려 한다.",en:"I work while thinking about what I learned in safety training.",vn:"Tôi làm việc와 nhớ lại nội dung đã học trong đào tạo an toàn.",ind:"Saya bekerja sambil mengingat apa yang dipelajari dalam pelatihan keselamatan."},
  {id:61,type:'S1',rev:true,kr:"규칙이 너무 많으면 몇 개는 무시해도 된다고 생각한다.",en:"I think if there are too many rules, some can be ignored.",vn:"Tôi nghĩ nếu có quá nhiều quy tắc thì có thể lờ đi một vài cái.",ind:"Saya pikir jika aturannya terlalu 많은, 몇몇은 무시해도 된다."},
  {id:62,type:'S1',rev:false,kr:"이유를 몰라도 안전 규칙은 무조건 지킨다.",en:"I follow safety rules unconditionally even if I don't know the reason.",vn:"Dù không biết lý do, tôi vẫn tuân thủ quy tắc an toàn vô điều kiện.",ind:"Saya mematuhi aturan keselamatan tanpa syarat meskipun tidak tahu alasannya."},
  {id:63,type:'S1',rev:false,kr:"작업 전에 위험한 것이 없는지 확인한다.",en:"I check for any dangers before working.",vn:"Tôi kiểm tra xem có gì nguy hiểm không trước khi làm việc.",ind:"Saya memeriksa apakah ada bahaya sebelum bekerja."},
  {id:64,type:'S2',rev:false,kr:"작업 전에 주변을 잘 살펴본다.",en:"I look around carefully before working.",vn:"Tôi quan sát kỹ xung quanh trước khi làm việc.",ind:"Saya melihat sekeliling와n cermat sebelum bekerja."},
  {id:65,type:'S2',rev:false,kr:"장비가 이상하면 바로 보고한다.",en:"If the equipment is strange, I report it immediately.",vn:"Nếu thiết bị có vấn đề, tôi báo cáo ngay.",ind:"Jika peralatan aneh, saya segera lapor."},
  {id:66,type:'S2',rev:true,kr:"위험한 상황을 별로 중요하지 않게 생각할 때가 있다.",en:"I sometimes think dangerous situations are not very important.",vn:"Đôi khi tôi nghĩ tình huống nguy hiểm không quan trọng lắm.",ind:"Terkadang saya menganggap situasi berbahaya tidak terlalu penting."},
  {id:67,type:'S2',rev:false,kr:"위험한 작업을 하기 전에는 꼼꼼하게 확인한다.",en:"I check thoroughly before doing dangerous work.",vn:"Tôi kiểm tra kỹ lưỡng trước khi làm công việc nguy hiểm.",ind:"Saya memeriksa dengan teliti sebelum melakukan pekerjaan berbahaya."},
  {id:68,type:'S2',rev:false,kr:"지나가는 길에 물건이 있으면 내가 먼저 치운다.",en:"If there are things in the way, I clear them first.",vn:"Nếu có đồ vật đặt ở lối đi, tôi sẽ chủ động dọn dẹp trước thay vì chờ người khác.",ind:"Jika ada barang di jalan, saya singkirkan dulu."},
  {id:69,type:'S2',rev:true,kr:"일하는 중에 장난을 치면 분위기가 좋아진다고 생각한다.",en:"I think playing around while working makes the atmosphere better.",vn:"Tôi nghĩ đùa giỡn trong khi làm việc sẽ làm không khí vui vẻ hơn.",ind:"Saya pikir bercanda saat bekerja membuat suasana lebih baik."},
  {id:70,type:'S2',rev:false,kr:"위험을 발견하면 바로 작업을 멈추고 알린다.",en:"If I find a danger, I stop work immediately and notify others.",vn:"Nếu phát hiện nguy hiểm, tôi dừng làm việc ngay와 thông báo.",ind:"Jika menemukan bahaya, saya langsung berhenti kerja dan memberi tahu."},
  {id:71,type:'A1',rev:false,kr:"새로운 일이 어려워도 배우려고 노력한다.",en:"Even if new work is hard, I try to learn it.",vn:"Dù việc mới khó, tôi vẫn cố gắng học.",ind:"Meskipun pekerjaan baru sulit, saya berusaha mempelajarinya."},
  {id:72,type:'A1',rev:true,kr:"일하는 방식이 바뀌면 처음에는 싫은 마음이 든다.",en:"When the way of working changes, I dislike it at first.",vn:"Khi cách làm việc thay đổi, ban đầu tôi thấy không thích.",ind:"Saat cara kerja berubah, awalnya saya merasa tidak suka."},
  {id:73,type:'A1',rev:false,kr:"문제가 생기면 불평하기보다 해결 방법을 찾는다.",en:"When a problem occurs, I look for a solution rather than complaining.",vn:"Khi có vấn đề, tôi tìm cách giải quyết thay vì phàn nàn.",ind:"Jika ada masalah, saya cari solusi daripada mengeluh."},
  {id:74,type:'A1',rev:false,kr:"새로운 장비는 사용법을 먼저 배우고 쓴다.",en:"I learn how to use new equipment before using it.",vn:"Tôi học cách sử dụng thiết bị mới trước rồi mới dùng.",ind:"Saya belajar cara pakai alat baru dulu sebelum menggunakannya."},
  {id:75,type:'A1',rev:false,kr:"새로운 방식보다 옛날 방식이 더 낫다고 느낄 때가 있다.",en:"I sometimes feel the old way is better than the new way.",vn:"Đôi khi tôi thấy cách cũ tốt hơn cách mới.",ind:"Terkadang saya merasa cara lama lebih baik daripada cara baru."},
  {id:76,type:'A1',rev:false,kr:"실패해도 배우는 것이 있다고 생각한다.",en:"I think there is something to learn even if I fail.",vn:"Tôi nghĩ dù thất bại cũng học được điều gì đó.",ind:"Saya pikir ada yang bisa dipelajari meski gagal."},
  {id:77,type:'A1',rev:false,kr:"작업 상황이 바뀌어도 빨리 적응한다.",en:"I adapt quickly even if the work situation changes.",vn:"Tôi thích nghi nhanh dù tình huống công việc thay đổi.",ind:"Saya cepat beradaptasi meski situasi kerja berubah."},
  {id:78,type:'A2',rev:false,kr:"지시 내용을 잘 모르면 알 때까지 물어본다.",en:"If I don't understand the instructions, I ask until I know.",vn:"Nếu không hiểu chỉ thị, tôi hỏi cho đến khi hiểu.",ind:"Jika tidak paham instruksi, saya tanya sampai tahu."},
  {id:79,type:'A2',rev:false,kr:"언어와 문화가 달라도 대화하려고 노력한다.",en:"Even if language and culture are different, I try to converse.",vn:"Dù ngôn ngữ và văn hóa khác biệt, tôi vẫn cố gắng trò chuyện.",ind:"Meskipun bahasa dan budaya berbeda, saya berusaha mengobrol."},
  {id:80,type:'A2',rev:true,kr:"도움을 요청하는 것이 부끄럽다.",en:"It is embarrassing to ask for help.",vn:"Việc yêu cầu giúp đỡ thật xấu hổ.",ind:"Meminta bantuan itu memalukan."},
  {id:81,type:'A2',rev:false,kr:"새로운 팀에 가면 먼저 인사한다.",en:"When I go to a new team, I greet them first.",vn:"Khi đến nhóm mới, tôi chào hỏi trước.",ind:"Saat masuk tim baru, saya menyapa duluan."},
  {id:82,type:'A2',rev:false,kr:"근무 시간이 바뀌어도 불평하지 않고 적응한다.",en:"I adapt without complaint even if work hours change.",vn:"Dù giờ làm việc thay đổi, tôi vẫn thích nghi không phàn nàn.",ind:"Meski jam kerja berubah, saya beradaptasi tanpa mengeluh."},
  {id:83,type:'A2',rev:true,kr:"새로운 사람과 일하면 피곤하다.",en:"Working with new people is tiring.",vn:"Làm việc với người mới thật mệt mỏi.",ind:"Bekerja dengan orang baru melelahkan."},
  {id:84,type:'A2',rev:false,kr:"다른 나라 동료와도 잘 지낸다.",en:"I get along well with colleagues from other countries.",vn:"Tôi hòa thuận với đồng nghiệp nước khác.",ind:"Saya rukun dengan rekan dari negara lain."},
  {id:85,type:'REL',rev:false,kr:"나는 태어나서 한 번도 마감 시간을 어긴 적이 없다.",en:"I have never missed a deadline in my life.",vn:"Tôi chưa bao giờ trễ hạn trong đời.",ind:"Saya tidak pernah melewatkan tenggat waktu seumur hidup saya."},
  {id:86,type:'REL',rev:false,kr:"나는 태어나서 한 번도 화를 낸 적이 없다.",en:"I have never gotten angry in my life.",vn:"Tôi chưa bao giờ tức giận trong đời.",ind:"Saya tidak pernah marah seumur hidup saya."},
  {id:87,type:'REL',rev:false,kr:"나는 태어나서 한 번도 규칙을 어긴 적이 없다.",en:"I have never broken a rule in my life.",vn:"Tôi chưa bao giờ vi phạm quy tắc trong đời.",ind:"Saya tidak pernah melanggar aturan seumur hidup saya."},
  {id:88,type:'REL',rev:false,kr:"나는 직장에서 동료와 다툰 적이 한 번도 없다.",en:"I have never fought with a colleague at work.",vn:"Tôi chưa bao giờ cãi nhau với đồng nghiệp tại nơi làm việc.",ind:"Saya tidak pernah bertengkar dengan rekan kerja di tempat kerja."},
  {id:89,type:'REL',rev:true,kr:"하기 싫어서 일을 미룰 때가 가끔 있다.",en:"I sometimes put off work because I don't want to do it.",vn:"Đôi khi tôi hoãn công việc vì không muốn làm.",ind:"Terkadang saya menunda pekerjaan karena malas."},
  {id:90,type:'REL',rev:true,kr:"기분이 안 좋으면 말을 안 할 때가 있다.",en:"I sometimes don't speak when I feel bad.",vn:"Khi tâm trạng không tốt, đôi khi tôi không nói chuyện.",ind:"Terkadang saya diam saat perasaan tidak enak."},
  {id:91,type:'REL',rev:true,kr:"나와 성격이 안 맞는 사람과 일하는 것은 불편하다.",en:"It is uncomfortable to work with someone who doesn't match my personality.",vn:"Làm việc với người không hợp tính cách thật không thoải mái.",ind:"Tidak nyaman bekerja dengan orang yang tidak cocok sifatnya."},
  {id:92,type:'REL',rev:true,kr:"내 실수를 인정하는 것이 마음 불편할 때가 있다.",en:"Admitting my mistakes is sometimes uncomfortable.",vn:"Thừa nhận lỗi lầm của mình đôi khi thấy khó chịu.",ind:"Mengakui kesalahan terkadang terasa tidak nyaman."},
  {id:93,type:'REL',rev:false,kr:"나는 하루 종일 일해도 전혀 피곤하지 않다.",en:"I am not tired at all even if I work all day.",vn:"Tôi không hề mệt mỏi dù làm việc cả ngày.",ind:"Saya sama sekali tidak lelah meski kerja seharian."},
  {id:94,type:'REL',rev:false,kr:"일이 아무리 힘들어도 스트레스를 전혀 받지 않는다.",en:"I don't get stressed at all no matter how hard the work is.",vn:"Tôi hoàn toàn không bị căng thẳng dù công việc vất vả thế nào.",ind:"Saya sama sekali tidak stres seberat apa pun pekerjaannya."}];
var MGMT_GUIDE={'C1':{title:"근태·시간",desc:"시간 엄수"},'C2':{title:"책임감",desc:"품질·완수"},'R1':{title:"규정 준수",desc:"규칙 이행"},'R2':{title:"정직성",desc:"투명한 보고"},'T1':{title:"협력 태도",desc:"팀워크"},'T2':{title:"갈등 관리",desc:"대인 관계"},'E1':{title:"감정 조절",desc:"평정심"},'E2':{title:"인내심",desc:"스트레스 관리"},'S1':{title:"안전 수칙",desc:"보호구 착용"},'S2':{title:"위험 인지",desc:"사전 예방"},'A1':{title:"학습 능력",desc:"업무 습득"},'A2':{title:"조직 적응",desc:"관계·문화"}};
let currentLang='',currentQIndex=0,userAnswers={},candidateData={};let timerInterval=null,remainingTime=1800,chartInstance=null;let globalLocalData=[],globalFileData=[],currentSearch="",currentFilter="ALL";let currentDateFilter="";let sortKey='date',sortOrder='desc';let currentViewingData=null;const LOCAL_DB_KEY='HD_E7_FINAL_V30';let isNavigating=false;let deleteCallback=null;let shuffledIndices=[]; 
document.getElementById('confirm-yes-btn').onclick=function(){if(deleteCallback)deleteCallback();document.getElementById('confirm-modal').classList.add('hidden');deleteCallback=null};
window.switchView=function(id){document.querySelectorAll('[id^="view-"]').forEach(el=>el.classList.add('hidden'));document.getElementById('view-report').classList.remove('active');const el=document.getElementById(id);if(el){el.classList.remove('hidden');if(id==='view-report')el.classList.add('active');if(window.updateReportScale)window.updateReportScale()}};window.selectLang=function(l){currentLang=l;document.querySelectorAll('.lang-btn-premium').forEach(b=>b.classList.remove('active'));const b=document.getElementById('btn-'+l);if(b)b.classList.add('active')};window.goToLogin=function(){window.switchView('view-login')};window.resetToHome=function(){currentQIndex=0;userAnswers={};candidateData={};remainingTime=1800;if(timerInterval)clearInterval(timerInterval);document.getElementById('input-name').value='';document.getElementById('input-id').value='';document.querySelectorAll('.likert-input').forEach(i=>i.checked=false);document.getElementById('progress-bar').style.width='0%';currentLang='';document.querySelectorAll('.lang-btn-premium').forEach(b=>b.classList.remove('active'));updateStoredCount();localStorage.removeItem('E7_SHUFFLED_ORDER');window.switchView('view-home')}; 
function updateStoredCount(){const db=JSON.parse(localStorage.getItem(LOCAL_DB_KEY)||'[]');document.getElementById('stored-count').textContent=db.length}
window.checkUrlAndStart=function(){window.switchView('view-login')};window.showGuide=function(){const n=document.getElementById('input-name').value;const i=document.getElementById('input-id').value;if(!currentLang||!n||!i)return showModal("정보 입력 및 언어 선택을 완료해주세요.");candidateData={name:n,id:i,startTime:new Date().toLocaleString()};const t=GUIDE_TEXTS[currentLang]||GUIDE_TEXTS['kr'];document.getElementById('guide-title').textContent=t.title;document.getElementById('guide-time').textContent=t.timeVal;document.getElementById('guide-count').textContent=t.countVal;document.getElementById('guide-warn').innerHTML=t.warnVal;document.getElementById('guide-btn').textContent=t.btn;window.switchView('view-guide')};
window.startRealTest=function(){const temp=localStorage.getItem('E7_TEMP_DATA');const storedOrder=localStorage.getItem('E7_SHUFFLED_ORDER');if(temp){if(confirm("이전에 진행 중이던 검사 내역이 있습니다. 이어하시겠습니까?")){try{const parsed=JSON.parse(temp);userAnswers=parsed.answers||{};currentQIndex=parsed.idx||0;remainingTime=parsed.time||1800;if(parsed.info)candidateData=parsed.info;if(storedOrder)shuffledIndices=JSON.parse(storedOrder);else{shuffledIndices=Array.from({length:QUESTIONS_FULL.length},(_,i)=>i);}window.switchView('view-assessment');loadQuestion(currentQIndex);startTimer();return;}catch(e){localStorage.removeItem('E7_TEMP_DATA');}}else{localStorage.removeItem('E7_TEMP_DATA');localStorage.removeItem('E7_SHUFFLED_ORDER');}}shuffledIndices=Array.from({length:QUESTIONS_FULL.length},(_,i)=>i);for(let i=shuffledIndices.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[shuffledIndices[i],shuffledIndices[j]]=[shuffledIndices[j],shuffledIndices[i]];}localStorage.setItem('E7_SHUFFLED_ORDER',JSON.stringify(shuffledIndices));window.switchView('view-assessment');loadQuestion(0);startTimer();window.addEventListener('beforeunload',preventExit);};
function preventExit(e){e.preventDefault();e.returnValue='';}
function startTimer(){const d=document.getElementById('timer-display');timerInterval=setInterval(()=>{remainingTime--;d.textContent=`${String(Math.floor(remainingTime/60)).padStart(2,'0')}:${String(remainingTime%60).padStart(2,'0')}`;if(remainingTime<=0){clearInterval(timerInterval);window.finishAssessment()}},1000)}
function loadQuestion(idx){if(idx>=QUESTIONS_FULL.length)return window.finishAssessment();currentQIndex=idx;const realIdx=shuffledIndices[idx];const q=QUESTIONS_FULL[realIdx];let txt=q.kr;if(currentLang==='vn')txt=q.vn;else if(currentLang==='en')txt=q.en;else if(currentLang==='id')txt=q.ind;document.getElementById('q-text-native').textContent=`${idx+1}. ${txt}`;document.getElementById('q-text-kr').textContent=q.kr;const labels={'vn':['Hoàn toàn không đồng ý','Không đồng ý','Bình thường','Đồng ý','Hoàn toàn đồng ý'],'kr':['전혀 그렇지 않다','그렇지 않은 편이다','보통이다','그런 편이다','매우 그렇다'],'en':['Strongly Disagree','Disagree','Neutral','Agree','Strongly Agree'],'id':['Sangat Tidak Setuju','Tidak Setuju','Netral','Setuju','Sangat Setuju']};const l=labels[currentLang]||labels.kr;const container=document.getElementById('likert-container');container.innerHTML='';for(let i=1;i<=5;i++){container.innerHTML+=`<div class="col-span-1 likert-item cursor-pointer group select-none py-2" onclick="window.chooseAnswer(${i})"><div class="likert-number-wrapper" style="height: 80px; display: flex; align-items: flex-end; justify-content: center; margin-bottom: 10px;"><input type="radio" name="q_answer" id="ans_${i}" value="${i}" class="likert-input hidden" ${userAnswers[q.id]==i?'checked':''}><label for="ans_${i}" class="w-10 h-10 md:w-14 md:h-14 lg:w-16 lg:h-16 responsive-circle rounded-full border-2 border-slate-200 flex items-center justify-center text-lg md:text-xl lg:text-2xl font-black text-slate-300 transition-all cursor-pointer group-hover:border-blue-400 group-hover:text-blue-500 bg-white shadow-sm likert-number-btn">${i}</label></div><span class="text-[11px] md:text-sm lg:text-base text-center text-slate-500 font-bold font-kor break-keep group-hover:text-blue-900 transition-colors px-1 likert-label-text">${l[i-1]}</span></div>`}document.getElementById('current-q-num').textContent=idx+1;document.getElementById('progress-bar').style.width=`${((idx)/94)*100}%`;document.getElementById('header-btn-prev').classList.toggle('hidden',idx===0);document.getElementById('btn-submit').classList.toggle('hidden',idx<93);isNavigating=false}
window.chooseAnswer=function(v){if(isNavigating)return;isNavigating=true;const realIdx=shuffledIndices[currentQIndex];const q=QUESTIONS_FULL[realIdx];userAnswers[q.id]=v;localStorage.setItem('E7_TEMP_DATA',JSON.stringify({answers:userAnswers,idx:currentQIndex,time:remainingTime,info:candidateData}));if(currentQIndex<93)setTimeout(()=>loadQuestion(currentQIndex+1),250);else{isNavigating=false;loadQuestion(currentQIndex)}};window.prevQuestion=function(){if(currentQIndex>0){isNavigating=false;loadQuestion(currentQIndex-1)}};
window.finishAssessment=async function(){const realIdx=shuffledIndices[currentQIndex];const lastQ=QUESTIONS_FULL[realIdx];if(!userAnswers[lastQ.id])return showModal("마지막 문항에 답변해주세요.");window.removeEventListener('beforeunload',preventExit);const elapsedTime=1800-remainingTime;clearInterval(timerInterval);document.body.style.pointerEvents='none';window.switchView('view-upload');const result=calculateAll(candidateData.name,userAnswers);if(elapsedTime<300){if(result.reliability.includes('V1')||result.reliability.includes('V2')){result.reliability='주의 (V3) - 시간미달';}result.isTooFast=true;}result.id=candidateData.id;result.date=candidateData.startTime;result.source="기기 직접 응시";saveLocal(result);localStorage.removeItem('E7_TEMP_DATA');localStorage.removeItem('E7_SHUFFLED_ORDER');if(GOOGLE_SCRIPT_URL){try{const sheetPayload={date:result.date,name:result.name,id:result.id,source:result.source,total:result.total,reliability:result.reliability,decision:result.decision,minScore:result.minScore};Object.assign(sheetPayload,result.details);for(let i=1;i<=94;i++){sheetPayload['Q'+i]=result.answers[i]||'';}await fetch(GOOGLE_SCRIPT_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(sheetPayload)});}catch(e){}}document.body.style.pointerEvents='auto';setTimeout(()=>window.switchView('view-thankyou'),1500)};
window.showAdminLogin=function(){window.switchView('view-admin-login')};window.checkAdminPw=function(){if(document.getElementById('admin-pw').value==="3269"){const local=JSON.parse(localStorage.getItem(LOCAL_DB_KEY)||'[]');globalLocalData=local.map(d=>({...d,source:"기기 저장"}));renderDashboard();window.switchView('view-admin-dashboard')}else showModal("비밀번호 오류")};window.downloadLocalData=function(){const db=JSON.parse(localStorage.getItem(LOCAL_DB_KEY)||'[]');if(db.length===0)return alert("저장된 데이터가 없습니다.");const d=db[db.length-1];const a=document.createElement('a');a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d));a.download=`E7_Result_${d.name}_${d.id}.json`;document.body.appendChild(a);a.click();a.remove()};
window.downloadTableAsExcel=function(){const data=[...globalLocalData,...globalFileData];if(data.length===0)return showModal("다운로드할 데이터가 없습니다.");const exportData=data.map(d=>{const row={'Source':d.source,'Name':d.name,'ID':d.id,'Date':getYYYYMMDD(d.date),'Total Score':d.total,'Grade':d.decision,'Reliability':d.reliability,'Min Score':d.minScore};Object.assign(row,d.details);return row;});const ws=XLSX.utils.json_to_sheet(exportData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Assessment_Results");XLSX.writeFile(wb,`HD_E7_Results_ALL_${new Date().toISOString().slice(0,10)}.xlsx`);};
window.handleFileUpload=function(input){const f=input.files[0];if(!f)return;if(f.name.toLowerCase().endsWith('.json')){const r=new FileReader();r.onload=(e)=>{try{const j=JSON.parse(e.target.result);(Array.isArray(j)?j:[j]).forEach(d=>{d.source="파일 백업 (JSON)";globalFileData.push(d);});renderDashboard();alert("백업 파일 로드 완료");}catch(e){alert("JSON 파일 형식이 올바르지 않습니다.");}};r.readAsText(f);}else{const r=new FileReader();r.onload=(e)=>{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,raw:false,dateNF:'yyyy-mm-dd'});let hIdx=rows.findIndex(r=>r&&r.some(c=>c&&c.toString().replace(/\s/g,'').match(/(종합점수|총점|Total)/i)));if(hIdx!==-1){const headers=rows[hIdx];const find=(k)=>headers.findIndex(h=>h&&k.some(x=>h.toString().replace(/\s/g,'').toUpperCase().includes(x.toUpperCase())));const findExact=(target)=>headers.findIndex(h=>{if(!h)return false;const cellStr=h.toString().replace(/\s/g,'').toUpperCase();const targetStr=String(target).toUpperCase();return cellStr===targetStr;});const map={name:find(['성명','이름','Name']),id:find(['ID','응시번호','Candidate']),total:find(['종합점수','총점','Total']),rel:find(['신뢰도','Reliability']),dec:find(['판정','등급','종합등급','Grade','Decision']),date:find(['일시','날짜','Date','Time','응시일자'])};for(let i=hIdx+1;i<rows.length;i++){const row=rows[i];if(!row||!row[map.name])continue;let det={};['C1','C2','R1','R2','T1','T2','E1','E2','S1','S2','A1','A2'].forEach(k=>{const idx=find([k]);if(idx!==-1)det[k]=parseFloat(row[idx]||0);});let answers={};for(let q=1;q<=94;q++){let qIdx=findExact(q);if(qIdx===-1)qIdx=findExact('Q'+q);if(qIdx===-1)qIdx=findExact('문항'+q);if(qIdx!==-1){let val=parseInt(row[qIdx]);if(!isNaN(val)&&val>=1&&val<=5){answers[q]=val;}}}const main={C:Math.round(((det.C1||0)+(det.C2||0))/2),R:Math.round(((det.R1||0)+(det.R2||0))/2),S:Math.round(((det.S1||0)+(det.S2||0))/2),T:Math.round(((det.T1||0)+(det.T2||0))/2),E:Math.round(((det.E1||0)+(det.E2||0))/2),A:Math.round(((det.A1||0)+(det.A2||0))/2)};globalFileData.push({source:"엑셀 업로드",name:row[map.name],id:row[map.id]||'-',total:parseFloat(row[map.total]||0),reliability:row[map.rel]||'-',decision:row[map.dec]||'-',details:det,mainDetails:main,minScore:Math.min(...Object.values(det)),date:map.date!==-1?row[map.date]:new Date().toLocaleString(),answers:answers});}renderDashboard();alert("엑셀 데이터 로드 완료");}else{showModal("엑셀 형식을 인식할 수 없습니다.");}};r.readAsArrayBuffer(f);}};
window.showQRCode=function(){document.getElementById('qr-url-input').value=window.location.href;document.getElementById('qr-modal').classList.remove('hidden');window.generateQRFromInput()};window.generateQRFromInput=function(){const c=document.getElementById('qrcode-display');c.innerHTML='';new QRCode(c,{text:document.getElementById('qr-url-input').value,width:300,height:300,colorDark:"#002c5f",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})};function saveLocal(d){const db=JSON.parse(localStorage.getItem(LOCAL_DB_KEY)||'[]');db.push(d);localStorage.setItem(LOCAL_DB_KEY,JSON.stringify(db))}
window.handleSearch=function(v){currentSearch=v.toLowerCase().trim();renderDashboard()};
window.handleDateFilter=function(v){currentDateFilter=v;renderDashboard()};
window.setFilter=function(g){currentFilter=g;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));document.getElementById('filter-'+g)?.classList.add('active');renderDashboard()};
window.deleteItem=function(s,id,d){window.showConfirm("선택한 항목을 정말 삭제하시겠습니까?",()=>{try{if(s==='기기 저장'){globalLocalData=globalLocalData.filter(i=>!(String(i.id)===String(id)&&String(i.date)===String(d)));localStorage.setItem(LOCAL_DB_KEY,JSON.stringify(globalLocalData.map(({source,...r})=>r)));renderDashboard()}else if(s.includes('파일')||s==='엑셀 업로드'){globalFileData=globalFileData.filter(i=>!(String(i.id)===String(id)&&String(i.date)===String(d)));renderDashboard()}else window.showModal("삭제할 수 없는 데이터 소스입니다.")}catch(e){window.showModal("오류가 발생했습니다: "+e.message)}})};
window.handleSort=function(k){if(sortKey===k)sortOrder=sortOrder==='asc'?'desc':'asc';else{sortKey=k;sortOrder='desc'}renderDashboard()};
function getTimestamp(v){if(!v)return 0;const d=new Date(v);if(!isNaN(d.getTime()))return d.getTime();const m=String(v).match(/(\d{4})[\.\-\/]\s?(\d{1,2})[\.\-\/]\s?(\d{1,2})/);if(m)return new Date(m[1],m[2]-1,m[3]).getTime();return 0;}
window.toggleAll=function(el){document.querySelectorAll('.row-chk').forEach(c=>c.checked=el.checked);};
window.deleteSelected=function(){const chks=document.querySelectorAll('.row-chk:checked');if(chks.length===0)return window.showModal("삭제할 항목을 선택해주세요.");window.showConfirm(`선택한 ${chks.length}개 항목을 삭제하시겠습니까?`,()=>{const dels=Array.from(chks).map(c=>({s:c.dataset.src,i:c.dataset.id,d:c.dataset.date}));dels.forEach(t=>{if(t.s==='기기 저장')globalLocalData=globalLocalData.filter(r=>!(String(r.id)===String(t.i)&&String(r.date)===String(t.d)));else globalFileData=globalFileData.filter(r=>!(String(r.id)===String(t.i)&&String(r.date)===String(t.d)));});localStorage.setItem(LOCAL_DB_KEY,JSON.stringify(globalLocalData.map(({source,...r})=>r)));renderDashboard();document.getElementById('chk-all').checked=false;});};
function renderDashboard(){const tb=document.getElementById('dashboard-tbody');tb.innerHTML='';let data=[...globalLocalData,...globalFileData];if(currentSearch)data=data.filter(d=>(d.name&&d.name.toLowerCase().includes(currentSearch))||(d.id&&d.id.toLowerCase().includes(currentSearch)));if(currentDateFilter){const fTime=new Date(currentDateFilter).setHours(0,0,0,0);data=data.filter(d=>{const ts=getTimestamp(d.date);return new Date(ts).setHours(0,0,0,0)===fTime;});}if(currentFilter!=='ALL')data=data.filter(d=>d.decision&&d.decision.includes(currentFilter));data.sort((a,b)=>{let va=a[sortKey],vb=b[sortKey];if(sortKey==='total'){va=parseFloat(va||0);vb=parseFloat(vb||0);}else if(sortKey==='date'){va=getTimestamp(va);vb=getTimestamp(vb);}else{va=String(va||'').toLowerCase();vb=String(vb||'').toLowerCase();}return va<vb?(sortOrder==='asc'?-1:1):(va>vb?(sortOrder==='asc'?1:-1):0)});['source','name','id','date','total','reliability','decision'].forEach(k=>{const el=document.getElementById('sort-arrow-'+k);if(el){el.textContent=k===sortKey?(sortOrder==='asc'?'▲':'▼'):'';el.parentElement.classList.toggle('text-blue-600',k===sortKey)}});data.forEach((r)=>{const tr=document.createElement('tr');tr.className="border-b hover:bg-blue-50 cursor-pointer transition-colors";tr.innerHTML=`<td class="px-4 py-4 text-center" onclick="event.stopPropagation()"><input type="checkbox" class="row-chk w-4 h-4 cursor-pointer accent-blue-600" data-src="${r.source}" data-id="${r.id}" data-date="${r.date}"></td><td class="px-4 py-4 text-center col-source cursor-pointer hover:text-blue-500 transition-colors select-none" onclick="window.handleSort('source')">${r.source}</td><td class="px-4 py-4 font-bold text-gray-600 font-eng col-id whitespace-normal break-all leading-snug">${r.id}</td><td class="px-4 py-4 font-black text-gray-900 font-kor text-base col-name whitespace-normal break-words leading-snug">${r.name}</td><td class="px-4 py-4 text-xs font-medium text-gray-500 font-eng col-date whitespace-normal leading-tight">${getYYYYMMDD(r.date)}</td><td class="px-4 py-4 font-black text-center font-eng text-lg text-blue-900 col-score">${r.total}</td><td class="px-4 py-4 text-xs text-center font-bold font-kor col-rel whitespace-normal leading-tight">${r.reliability}</td><td class="px-4 py-4 text-center col-grade"><span class="px-3 py-1 rounded-full text-xs font-black shadow-sm bg-blue-100 text-blue-700 whitespace-nowrap">${r.decision}</span></td><td class="px-4 py-4 text-xs text-center text-blue-600 font-black hover:underline col-action">VIEW ></td>`;Array.from(tr.children).slice(1).forEach(td=>td.onclick=()=>window.showReport(r));tb.appendChild(tr)});document.getElementById('db-count-badge').textContent=data.length;updateStoredCount()}

// Function for EXECUTIVE REPORT (Updated v37.5 - Layout Optimized)
window.generateExecutiveReport=function(){
    const tb=document.getElementById('dashboard-tbody');
    if(!tb.children.length)return window.showModal("분석할 데이터가 없습니다.");
    
    let data=[...globalLocalData,...globalFileData];
    if(currentSearch)data=data.filter(d=>(d.name&&d.name.toLowerCase().includes(currentSearch))||(d.id&&d.id.toLowerCase().includes(currentSearch)));
    if(currentDateFilter){const fTime=new Date(currentDateFilter).setHours(0,0,0,0);data=data.filter(d=>{const ts=getTimestamp(d.date);return new Date(ts).setHours(0,0,0,0)===fTime;});}
    if(currentFilter!=='ALL')data=data.filter(d=>d.decision&&d.decision.includes(currentFilter));
    if(data.length===0)return window.showModal("분석할 데이터가 없습니다.");
    
    // Sort by ID (Ascending)
    data.sort((a,b)=>{
        const idA = String(a.id || '').toLowerCase();
        const idB = String(b.id || '').toLowerCase();
        if(idA < idB) return -1;
        if(idA > idB) return 1;
        return 0;
    });

    const totalCnt=data.length;
    const cCnts={S:0,A:0,B1:0,B2:0,C1:0,C2:0,D:0};
    const factorSum={C:0,R:0,S:0,T:0,E:0,A:0};
    let totalScoreSum=0;
    let riskCnt=0;
    
    data.forEach(d=>{
        let code='B1';
        if(d.decision.includes('('))code=d.decision.match(/\(([^)]+)\)/)[1];
        else code=d.decision;
        code=code.replace(/[^A-Z0-9]/g,'');
        if(code === 'C') code = (d.total < 50) ? 'C2' : 'C1';
        else if (code === 'B') code = (d.total < 66) ? 'B2' : 'B1';
        if(cCnts[code]!==undefined)cCnts[code]++;
        else{
            if(code.includes('S'))cCnts.S++;
            else if(code.includes('A'))cCnts.A++;
            else if(code.includes('B1'))cCnts.B1++;
            else if(code.includes('B2'))cCnts.B2++;
            else if(code.includes('C1'))cCnts.C1++;
            else if(code.includes('C2'))cCnts.C2++;
            else if(code.includes('D'))cCnts.D++;
        }
        totalScoreSum+=d.total;
        let main=d.mainDetails;
        if(!main&&d.details){
            const s=d.details;
            main={C:Math.round(((s.C1||0)+(s.C2||0))/2),R:Math.round(((s.R1||0)+(s.R2||0))/2),S:Math.round(((s.S1||0)+(s.S2||0))/2),T:Math.round(((s.T1||0)+(s.T2||0))/2),E:Math.round(((s.E1||0)+(s.E2||0))/2),A:Math.round(((s.A1||0)+(s.A2||0))/2)};
        }
        if(main){Object.keys(factorSum).forEach(k=>factorSum[k]+=(main[k]||0));}
        if(d.reliability.includes('V3')||d.reliability.includes('V4')||d.reliability.includes('V5'))riskCnt++;
    });

    const passCnt=cCnts.S+cCnts.A+cCnts.B1;
    const reviewCnt=cCnts.B2+cCnts.C1;
    const dangerCnt=cCnts.C2;
    const failCnt=cCnts.D;
    const avgScore=(totalScoreSum/totalCnt).toFixed(1);
    const passRate=((passCnt/totalCnt)*100).toFixed(1);
    
    let summaryText=`금번 평가 대상자 총 <span class="text-blue-600 font-black">${totalCnt}명</span> 중 합격(B1등급 이상) 인원은 <span class="text-blue-600 font-black">${passCnt}명(${passRate}%)</span>입니다. 보류(B2, C1) 인원은 ${reviewCnt}명이며, 위험(C2) 및 부적격(D) 인원은 총 ${dangerCnt+failCnt}명으로 집계되었습니다. `;
    if(parseFloat(avgScore)>=80)summaryText+="전반적인 인력 수준은 <strong>'우수'</strong>하며, 현장 투입 시 빠른 적응이 기대됩니다. ";
    else if(parseFloat(avgScore)>=70)summaryText+="전반적인 인력 수준은 <strong>'양호'</strong>하나, 일부 인원에 대한 직무 교육이 필요할 것으로 판단됩니다. ";
    else summaryText+="전반적인 인력 수준이 다소 <strong>'미흡'</strong>하여, 채용 선별에 각별한 주의가 요구됩니다. ";
    
    const mainFactorKeys=['C','R','S','T','E','A'];
    const mainFactorNames={C:'근태/책임',R:'규범/정직',S:'안전의식',T:'조직협력',E:'정서안정',A:'직무적응'};
    const factorAvgs=mainFactorKeys.map(k=>({k,v:(factorSum[k]/totalCnt).toFixed(1),name:mainFactorNames[k]})).sort((a,b)=>b.v-a.v);
    const strong=factorAvgs[0];
    const weak=factorAvgs[factorAvgs.length-1];
    
    summaryText+=`<br>세부 역량 측면에서는 <strong>'${strong.name}'</strong> 점수가 가장 높게 나타났으나, <strong>'${weak.name}'</strong> 역량은 상대적으로 취약하여 이에 대한 보완 대책(교육 등)이 권장됩니다.`;
    if(riskCnt>0)summaryText+=`<br><span class="text-red-500 font-bold">※ 특이사항:</span> 응답 신뢰도가 낮은 인원이 ${riskCnt}명 식별되어 면접 시 심층 검증이 필요합니다.`;
    
    const reportView=document.getElementById('view-report');
    const wrapper=document.getElementById('report-content-wrapper');
    reportView.classList.remove('hidden');
    reportView.classList.add('active');
    
    // HTML Template (2 Pages)
    wrapper.innerHTML=`
    <!-- Page 1: Cover -->
    <div class="a4-page executive-cover">
        <div style="width:100%;height:100%;border:4px double rgba(255,255,255,0.2);padding:40px;box-sizing:border-box;display:flex;flex-direction:column;justify-content:space-between;">
            <div style="text-align:right;opacity:0.6;">
                <img src="hd_logo.png" style="height:40px;filter:brightness(0) invert(1);" onerror="this.style.display='none'">
            </div>
            <div>
                <div style="font-size:1.5rem;font-weight:700;margin-bottom:20px;opacity:0.8;letter-spacing:0.2em;">CONFIDENTIAL</div>
                <div style="font-size:3.5rem;font-weight:900;line-height:1.2;margin-bottom:40px;text-shadow:0 10px 30px rgba(0,0,0,0.3);">E-7 외국인 근로자<br><span style="color:#60a5fa">인성검사 총괄 보고서</span></div>
                <div style="font-size:1.5rem;font-weight:500;border-top:1px solid rgba(255,255,255,0.3);border-bottom:1px solid rgba(255,255,255,0.3);padding:20px 0;display:inline-block;min-width:300px;">${getYYYYMMDD(new Date())}</div>
            </div>
            <div style="text-align:center;font-size:1rem;opacity:0.7;font-weight:300;">HD HYUNDAI SAMHO<br>Human Resources Development Team</div>
        </div>
    </div>

    <!-- Page 2: Executive Summary & Guide -->
    <div class="a4-page">
        <div class="report-header">
            <div>
                <div class="text-3xl font-black text-[#002c5f] font-eng uppercase">Executive Summary</div>
                <div class="text-sm font-black text-gray-400 mt-1 uppercase tracking-widest font-kor">종합 분석 및 현황</div>
            </div>
            <div class="text-right"><div class="text-lg font-black text-gray-800 font-kor">총원: ${totalCnt}명</div><div class="text-sm text-gray-500 font-bold">${getYYYYMMDD(new Date())} 기준</div></div>
        </div>

        <div class="executive-section" style="margin-bottom:10px; padding-bottom:5px;">
            <div class="section-title" style="font-size:1.1rem; margin-bottom:4px;"><span>📝</span> 종합 검토 의견</div>
            <div class="executive-summary-box" style="padding:10px 15px; margin-bottom:5px; font-size:0.95rem;">${summaryText}</div>
        </div>

        <div class="grid grid-cols-4 gap-4 mb-4 executive-section" style="border:none; padding-bottom:0;">
            <div class="score-card highlight-card"><div class="label">평균 점수</div><div class="value">${avgScore}</div></div>
            <div class="score-card"><div class="label">합격 (Pass)</div><div class="value text-blue-600">${passCnt} <span class="text-sm text-gray-400">(${passRate}%)</span></div><div class="text-xs text-gray-500 mt-1 font-bold">S:${cCnts.S} | A:${cCnts.A} | B1:${cCnts.B1}</div></div>
            <div class="score-card"><div class="label">보류 (Review)</div><div class="value text-orange-500">${reviewCnt}</div><div class="text-xs text-gray-500 mt-1 font-bold">B2:${cCnts.B2} | C1:${cCnts.C1}</div></div>
            <div class="score-card"><div class="label">위험/부적격</div><div class="value text-red-500">${dangerCnt+failCnt}</div><div class="text-xs text-gray-500 mt-1 font-bold">C2:${cCnts.C2} | D:${cCnts.D}</div></div>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-2 h-[180px]">
            <div class="flex flex-col h-full">
                <div class="section-title" style="font-size:1.1rem; margin-bottom:4px;"><span>📊</span> 종합 등급 분포</div>
                <div class="chart-wrapper flex-1 relative bg-white rounded-xl p-2 w-full flex items-center justify-center">
                    <canvas id="execGradeChart"></canvas>
                </div>
            </div>
            <div class="flex flex-col h-full">
                <div class="section-title" style="font-size:1.1rem; margin-bottom:4px;"><span>📈</span> 6대 핵심 역량 (Radar)</div>
                <div class="chart-wrapper flex-1 relative bg-white rounded-xl p-2 w-full flex items-center justify-center">
                    <canvas id="execFactorChart"></canvas>
                </div>
            </div>
        </div>

        <div class="mt-auto flex-grow flex flex-col justify-end pb-2">
            <div class="section-title" style="font-size:1rem; margin-bottom:4px; border-bottom:1px solid #e2e8f0; padding-bottom:2px;">📌 등급별 상세 정의 및 채용 가이드</div>
            <div class="grid grid-cols-2 gap-4">
                <table class="exec-table">
                    <thead style="background:#f8fafc;">
                        <tr><th style="width:15%">등급</th><th style="width:20%">판정</th><th>정의 및 가이드</th></tr>
                    </thead>
                    <tbody>
                        <tr><td class="text-center font-bold text-blue-700">S</td><td class="text-center font-bold">최우수</td><td>조직/직무 역량 탁월 (즉시 투입)</td></tr>
                        <tr><td class="text-center font-bold text-blue-600">A</td><td class="text-center font-bold">우수</td><td>전반적 역량 우수 (채용 권장)</td></tr>
                        <tr><td class="text-center font-bold text-green-600">B1</td><td class="text-center font-bold">보통</td><td>기본 소양 보유 (채용 권장)</td></tr>
                        <tr><td class="text-center font-bold text-yellow-600">B2</td><td class="text-center font-bold">관찰</td><td>역량 평이 (초기 멘토링)</td></tr>
                    </tbody>
                </table>
                <table class="exec-table">
                    <thead style="background:#f8fafc;">
                        <tr><th style="width:15%">등급</th><th style="width:20%">판정</th><th>정의 및 가이드</th></tr>
                    </thead>
                    <tbody>
                        <tr><td class="text-center font-bold text-orange-500">C1</td><td class="text-center font-bold">검토</td><td>취약점/신뢰도 저하 (심층 검증)</td></tr>
                        <tr><td class="text-center font-bold text-orange-600">C2</td><td class="text-center font-bold">위험</td><td>안전의식 낮음 (특별 관리)</td></tr>
                        <tr><td class="text-center font-bold text-red-600">D</td><td class="text-center font-bold">부적격</td><td>부적응/불성실 (채용 불가)</td></tr>
                        <tr><td colspan="3" style="border:none; height:18px;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="pt-2 text-center text-[10px] text-gray-300 font-black uppercase tracking-widest">HD HYUNDAI SAMHO - HR REPORT</div>
    </div>

    <!-- Page 3: Detailed List -->
    <div class="a4-page">
        <div class="report-header">
            <div><div class="text-2xl font-black text-[#002c5f] font-eng uppercase">Detailed List</div><div class="text-sm font-black text-gray-400 mt-1 uppercase tracking-widest font-kor">주요 대상자 세부 내역</div></div>
        </div>
        <div class="flex-grow overflow-hidden">
            <table class="w-full text-xs border-collapse">
                <thead class="bg-slate-100 border-b-2 border-slate-200 font-bold text-slate-600 uppercase">
                    <tr><th class="p-2 text-center w-[15%]">ID</th><th class="p-2 text-center w-[20%]">성명</th><th class="p-2 text-center w-[10%]">점수</th><th class="p-2 text-center w-[10%]">등급</th><th class="p-2 text-center w-[15%]">신뢰도</th><th class="p-2 text-center w-[10%]">안전</th><th class="p-2 text-center w-[20%]">비고</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    ${data.map(d=>{
                        let code='B1';
                        if(d.decision.includes('('))code=d.decision.match(/\(([^)]+)\)/)[1];
                        else code=d.decision;
                        code=code.replace(/[^A-Z0-9]/g,'');
                        if(code === 'C') code = (d.total < 50) ? 'C2' : 'C1';
                        else if (code === 'B') code = (d.total < 66) ? 'B2' : 'B1';
                        const isRisk=code==='C2'||code==='D'||d.reliability.includes('V3')||d.reliability.includes('V4');
                        const rowClass=isRisk?"bg-red-50":"";
                        return`<tr class="${rowClass}"><td class="p-2 font-mono text-gray-500 text-center">${d.id}</td><td class="p-2 font-bold text-gray-800 text-center break-keep">${d.name}</td><td class="p-2 text-center font-bold">${d.total}</td><td class="p-2 text-center"><span class="grade-badge ${code.includes('S')?'grade-S':code.includes('A')?'grade-A':code.includes('B')?'grade-B':code.includes('C')?'grade-C':'grade-D'}">${code}</span></td><td class="p-2 text-center ${d.reliability.includes('V3')||d.reliability.includes('V4')?'text-red-600 font-bold':''}">${d.reliability.split('(')[0]}</td><td class="p-2 text-center">${d.details.S1}/${d.details.S2}</td><td class="p-2 text-gray-500 text-center break-keep leading-tight">${isRisk?(code==='D'?'채용부적격':(d.reliability.includes('V3')?'신뢰도검증':'심층면접필요')):'-'}</td></tr>`
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="mt-4 pt-4 text-center text-xs text-gray-300 font-black uppercase tracking-widest">End of Document</div>
    </div>

    <div class="text-center no-print my-10 pb-20">
        <button onclick="window.printExecutiveReport()" class="bg-slate-800 hover:bg-slate-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg mr-4">🖨️ 인쇄 / PDF 저장</button>
        <button onclick="window.closeReport()" class="bg-white border hover:bg-gray-50 text-gray-600 px-8 py-4 rounded-xl font-bold ml-4">닫기</button>
    </div>`;

    if(chartInstance)chartInstance.destroy();
    Chart.register(ChartDataLabels);

    const radarData = mainFactorKeys.map(k=>(factorSum[k]/totalCnt).toFixed(1));
    
    new Chart(document.getElementById('execGradeChart'),{
        type:'doughnut',
        data:{
            labels:['합격','보류','위험','부적격'],
            datasets:[{
                data:[passCnt,reviewCnt,dangerCnt,failCnt],
                backgroundColor:['#3b82f6','#fbbf24','#f97316','#ef4444'],
                borderWidth:0
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{position:'right',labels:{font:{size:11,weight:'bold'}}},
                datalabels:{color:'white',font:{weight:'bold'},formatter:(v,ctx)=>v>0?v+'명':''}
            }
        }
    });

    new Chart(document.getElementById('execFactorChart'),{
        type:'radar',
        data:{
            labels: mainFactorKeys.map(k=>mainFactorNames[k]),
            datasets:[{
                label:'평균 점수',
                data: radarData,
                backgroundColor:'rgba(59, 130, 246, 0.2)',
                borderColor:'#3b82f6',
                borderWidth:2,
                pointBackgroundColor:'#3b82f6'
            },{
                label:'목표 점수',
                data:[80,80,80,80,80,80],
                backgroundColor:'transparent',
                borderColor:'#ef4444',
                borderWidth:2,
                borderDash:[5,5],
                pointRadius:0
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
                r:{
                    min:0, max:100,
                    ticks:{stepSize:20, display:false},
                    pointLabels:{font:{size:11, weight:'bold'}, color:'#334155'}
                }
            },
            plugins:{
                legend:{position:'top', labels:{boxWidth:10, font:{size:11}}},
                datalabels:{
                    display:true,
                    color:'#002c5f',
                    font:{weight:'bold', size:11},
                    formatter:(v)=>v
                }
            }
        }
    });

    if(window.updateReportScale) window.updateReportScale();
};

window.showReport = function(d) {
    currentViewingData = d;
    const factors = Object.keys(d.details);
    const stats = {};
    let validStatsData = [...globalLocalData, ...globalFileData].filter(item => {
        const r = String(item.reliability || "");
        return !r.includes("V4") && !r.includes("V5");
    });
    if (validStatsData.length === 0) {
        validStatsData = [...globalLocalData, ...globalFileData].length > 0 ? [...globalLocalData, ...globalFileData] : [d];
    }
    factors.forEach(f => {
        const values = validStatsData.map(r => r.details[f] || 0);
        stats[f] = { avg: (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1) };
    });
    
    const reportView = document.getElementById('view-report');
    const wrapper = document.getElementById('report-content-wrapper');
    reportView.classList.remove('hidden');
    reportView.classList.add('active');
    
    const decDesc = generateReportComment(d);
    const relDesc = generateReliabilityComment(d);
    
    const getGradeColor = (str) => {
        if (str.includes('S') || str.includes('최우수')) return '#1e40af';
        if (str.includes('A') || str.includes('우수')) return '#2563eb';
        if (str.includes('B') || str.includes('보통')) return '#059669';
        if (str.includes('C1') || str.includes('주의')) return '#d97706';
        if (str.includes('C2') || str.includes('위험')) return '#dc2626';
        return '#dc2626';
    };
    
    const getRelColor = (str) => {
        if (str.includes('V1') || str.includes('높음')) return '#1e40af';
        if (str.includes('V2')) return '#2563eb';
        if (str.includes('V3')) return '#d97706';
        return '#dc2626';
    };
    
    const getGrade = (s) => {
        if (s >= 90) return { t: 'S', c: 'grade-S' };
        if (s >= 80) return { t: 'A', c: 'grade-A' };
        if (s >= 60) return { t: 'B', c: 'grade-B' };
        if (s >= 40) return { t: 'C', c: 'grade-C' };
        return { t: 'D', c: 'grade-D' };
    };

    wrapper.innerHTML = `<div class="a4-page"><div class="report-header"><div><img src="hd_logo.png" class="h-10 mb-2" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="text-3xl font-black text-[#002c5f] tracking-tighter uppercase font-eng">HD HYUNDAI SAMHO</div><div class="text-sm font-black text-gray-400 mt-1 uppercase tracking-widest font-kor">E-7 외국인 근로자 인성검사 리포트</div></div><div class="text-right"><div class="text-[10px] text-white bg-[#002c5f] px-2 py-0.5 rounded font-bold uppercase inline-block mb-1">Official Document</div><div class="text-lg font-black text-gray-800 font-kor">${d.name} <span class="text-base text-gray-500 font-bold">(${d.id})</span></div><div class="text-lg font-bold text-gray-500 font-eng mt-1">${getYYYYMMDD(d.date || new Date())}</div></div></div><div class="grid grid-cols-4 gap-4 mb-8"><div class="score-card highlight-card"><div class="label">종합 점수</div><div class="value">${d.total}</div></div><div class="score-card"><div class="label">종합 등급</div><div class="value" style="color:${getGradeColor(d.decision)}">${d.decision.split(' (')[0]}</div></div><div class="score-card"><div class="label">신뢰도</div><div class="value" style="color:${getRelColor(d.reliability)}">${d.reliability.split(' (')[0]}</div></div><div class="score-card"><div class="label">최저 점수</div><div class="value" style="color:#64748b">${d.minScore}</div></div></div><div class="grid grid-cols-2 gap-8 mb-6 h-[480px]"><div class="flex flex-col h-full"><div class="section-title"><span>📊</span> 역량 비교 프로파일</div><div class="chart-wrapper flex-1 relative bg-white rounded-xl p-2 w-full"><canvas id="mainChart"></canvas></div></div><div class="flex flex-col h-full"><div class="section-title"><span>📝</span> 세부 점수 및 등급</div><div class="flex-1 w-full"><table class="score-table h-full w-full">${Object.keys(d.details).map(k => { const s = d.details[k], g = getGrade(s), c = s >= 80 ? '#1e3a8a' : (s >= 60 ? '#3b82f6' : '#ef4444'); return `<tr><td width="35%"><span class="font-eng text-slate-400 text-[10px] mr-1">${k}</span>${MGMT_GUIDE[k].title}</td><td width="15%" class="text-center"><span class="grade-badge ${g.c}">${g.t}</span></td><td width="35%"><div style="background:#f1f5f9;border-radius:4px;height:8px;overflow:hidden"><div style="width:${s}%;background:${c};height:100%"></div></div></td><td width="15%" style="color:${c};font-weight:800;text-align:center;">${s}</td></tr>` }).join('')}</table></div></div></div><div class="grid grid-cols-2 gap-8 border-t border-transparent pt-6" style="margin-top:0.1cm;"><div class="flex flex-col h-full"><div class="section-title"><span>📌</span> 종합 판정</div><div class="bg-white rounded-xl border border-[#e2e8f0] p-5 flex-grow shadow-sm"><p class="text-[0.95rem] text-slate-700 leading-relaxed text-justify break-keep font-medium">${decDesc}</p></div></div><div class="flex flex-col h-full"><div class="section-title"><span>🔍</span> 신뢰도 분석</div><div class="bg-white rounded-xl border border-[#e2e8f0] p-5 flex-grow shadow-sm"><p class="text-[0.95rem] text-slate-700 leading-relaxed text-justify break-keep font-medium">${relDesc}</p></div></div></div></div><div id="ai-result-container"></div><div class="text-center no-print my-10 pb-20"><button onclick="window.printReportContent()" class="bg-slate-800 hover:bg-slate-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg mr-4 transition-all hover:-translate-y-1">🖨️ 인쇄 / PDF 저장</button><button id="btn-ai-generate" onclick="generateAIAnalysis(currentViewingData)" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black py-4 px-8 rounded-xl shadow-lg transition-all hover:-translate-y-1 hover:shadow-xl inline-flex items-center gap-2"><span>✨</span> AI 심층 분석 (Premium)</button><button onclick="window.closeReport()" class="bg-white border hover:bg-gray-50 text-gray-600 px-8 py-4 rounded-xl font-bold ml-4 shadow-sm">닫기</button></div>`;
    
    if (chartInstance) chartInstance.destroy();
    Chart.register(ChartDataLabels);
    
    chartInstance = new Chart(document.getElementById('mainChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: Object.keys(d.details).map(k => MGMT_GUIDE[k].title),
            datasets: [{
                label: '평균',
                data: Object.keys(d.details).map(k => stats[k].avg),
                type: 'line',
                borderColor: '#ef4444',
                borderWidth: 3,
                pointBackgroundColor: '#ef4444',
                tension: 0.3,
                order: 0,
                datalabels: {
                    color: '#ef4444',
                    anchor: 'start',
                    align: 'right',
                    offset: 6,
                    font: { weight: 'bold', size: 13 },
                    formatter: Math.round
                }
            }, {
                label: '본인',
                data: Object.values(d.details),
                backgroundColor: 'rgba(30,58,138,0.9)',
                borderRadius: 4,
                barPercentage: 1.0,
                categoryPercentage: 0.8,
                order: 1,
                datalabels: {
                    color: 'white',
                    anchor: 'center',
                    align: 'center',
                    font: { weight: 'bold', size: 13 }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { min: 0, max: 110, grid: { color: '#f1f5f9' }, ticks: { font: { size: 13, weight: 'bold' } } },
                y: { grid: { display: false }, ticks: { font: { family: "'Noto Sans KR'", weight: '700', size: 13 } } }
            },
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: true, formatter: Math.round }
            },
            layout: { padding: { right: 30 } }
        }
    });
    
    window.updateReportScale();
};
window.printReportContent=function(){const cvs=document.getElementById('mainChart');const url=cvs?cvs.toDataURL("image/png"):'';const cts=document.getElementById('report-content-wrapper').innerHTML;const w=window.open('','_blank','width=1100,height=1010');if(!w)return window.showModal('팝업 차단을 해제해주세요.');w.document.write(`<html><head><title>인성검사 리포트</title><script src="https://cdn.tailwindcss.com/3.4.1"><\/script><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet"><style>@page{size:A4 portrait;margin:10mm}body{margin:0;padding:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-family:'Noto Sans KR',sans-serif;background:white}.a4-page{width:210mm;min-height:297mm;padding:10mm 15mm;margin:0 auto;page-break-after:always;box-sizing:border-box;display:flex;flex-direction:column}.a4-page:last-child{page-break-after:auto}.executive-cover{background:linear-gradient(135deg,#002c5f 0%,#001a38 100%)!important;color:white!important;-webkit-print-color-adjust:exact}.report-header{border-bottom:3px solid #002c5f;padding-bottom:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-end}.executive-section{margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}.executive-summary-box{background:#f1f5f9!important;border-left:5px solid #002c5f!important;padding:15px 20px;border-radius:8px;font-size:1rem;line-height:1.7;color:#334155;text-align:justify;margin-bottom:20px;font-weight:500}.score-card{background:#f8fafc!important;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center}.score-card.highlight-card{background-color:#002c5f!important;border-color:#002c5f!important;color:white!important}.score-card.highlight-card .label{color:#bfdbfe!important}.score-card.highlight-card .value{color:#ffffff!important}.label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#64748b;font-weight:700;margin-bottom:4px}.value{font-size:1.6rem;font-weight:900;color:#002c5f;line-height:1.2;font-family:'Noto Sans KR',sans-serif;word-break:keep-all}.section-title{font-size:1.2rem;font-weight:900;color:#002c5f;display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e2e8f0}.chart-wrapper{position:relative;width:100%}canvas{display:none!important}.printed-chart-img{width:100%;height:100%;object-fit:contain;display:block}.grade-badge{display:inline-block;width:22px;height:22px;line-height:22px;text-align:center;border-radius:50%;font-weight:900;font-size:0.8rem;color:white;font-family:'Roboto',sans-serif}.grade-S{background-color:#4f46e5!important}.grade-A{background-color:#3b82f6!important}.grade-B{background-color:#10b981!important}.grade-C{background-color:#f59e0b!important}.grade-D{background-color:#ef4444!important}.text-blue-600{color:#2563eb!important}.text-orange-500{color:#f97316!important}.text-red-500{color:#ef4444!important}.no-print{display:none!important}table{width:100%;border-collapse:collapse}th,td{padding:4px 8px;border-bottom:1px solid #e2e8f0}thead th{background-color:#f8fafc!important;border-bottom:2px solid #e2e8f0}/* Executive Table Print Styles */.exec-table{width:100%;border-collapse:collapse;font-size:10px}.exec-table th{background-color:#f1f5f9!important;color:#475569!important;font-weight:800;text-align:center;padding:4px;border:1px solid #cbd5e1}.exec-table td{border:1px solid #e2e8f0;padding:4px;vertical-align:middle;color:#334155;word-break:keep-all}.exec-table tr:nth-child(even){background-color:#f8fafc!important}</style></head><body>${cts}<script>const w=document.querySelector('.chart-wrapper');if(w&&'${url}'){const i=document.createElement('img');i.src='${url}';i.className='printed-chart-img';w.appendChild(i);const c=w.querySelector('canvas');if(c)c.remove()}setTimeout(()=>{window.print();window.close()},800);<\/script></body></html>`);w.document.close()};
window.printExecutiveReport=function(){const gCvs=document.getElementById('execGradeChart');const fCvs=document.getElementById('execFactorChart');const gUrl=gCvs?gCvs.toDataURL("image/png"):'';const fUrl=fCvs?fCvs.toDataURL("image/png"):'';const content=document.getElementById('report-content-wrapper').innerHTML;const w=window.open('','_blank','width=1100,height=1010');if(!w)return window.showModal("팝업 차단을 해제해주세요.");w.document.write(`<html><head><title>인성검사 총괄 보고서</title><script src="https://cdn.tailwindcss.com/3.4.1"><\/script><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet"><style>@page{size:A4 portrait;margin:10mm}body{margin:0;padding:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-family:'Noto Sans KR',sans-serif;background:white}.a4-page{width:210mm;min-height:297mm;padding:10mm 15mm;margin:0 auto;page-break-after:always;box-sizing:border-box;display:flex;flex-direction:column}.a4-page:last-child{page-break-after:auto}.executive-cover{background:linear-gradient(135deg,#002c5f 0%,#001a38 100%)!important;color:white!important;-webkit-print-color-adjust:exact}.report-header{border-bottom:3px solid #002c5f;padding-bottom:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-end}.executive-section{margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}.executive-summary-box{background:#f1f5f9!important;border-left:5px solid #002c5f!important;padding:15px 20px;border-radius:8px;font-size:1rem;line-height:1.7;color:#334155;text-align:justify;margin-bottom:20px;font-weight:500}.score-card{background:#f8fafc!important;border:1px solid #e2e8f0;border-radius:8px;padding:10px;text-align:center}.score-card.highlight-card{background-color:#002c5f!important;border-color:#002c5f!important;color:white!important}.score-card.highlight-card .label{color:#bfdbfe!important}.score-card.highlight-card .value{color:#ffffff!important}.label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:#64748b;font-weight:700;margin-bottom:4px}.value{font-size:1.6rem;font-weight:900;color:#002c5f;line-height:1.2;font-family:'Noto Sans KR',sans-serif;word-break:keep-all}.section-title{font-size:1.2rem;font-weight:900;color:#002c5f;display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e2e8f0}.chart-wrapper{position:relative;width:100%}canvas{display:none!important}.printed-chart-img{width:100%;height:100%;object-fit:contain;display:block}.grade-badge{display:inline-block;width:22px;height:22px;line-height:22px;text-align:center;border-radius:50%;font-weight:900;font-size:0.8rem;color:white;font-family:'Roboto',sans-serif}.grade-S{background-color:#4f46e5!important}.grade-A{background-color:#3b82f6!important}.grade-B{background-color:#10b981!important}.grade-C{background-color:#f59e0b!important}.grade-D{background-color:#ef4444!important}.text-blue-600{color:#2563eb!important}.text-orange-500{color:#f97316!important}.text-red-500{color:#ef4444!important}.no-print{display:none!important}table{width:100%;border-collapse:collapse}th,td{padding:4px 8px;border-bottom:1px solid #e2e8f0}thead th{background-color:#f8fafc!important;border-bottom:2px solid #e2e8f0}/* Executive Table Print Styles */.exec-table{width:100%;border-collapse:collapse;font-size:10px}.exec-table th{background-color:#f1f5f9!important;color:#475569!important;font-weight:800;text-align:center;padding:4px;border:1px solid #cbd5e1}.exec-table td{border:1px solid #e2e8f0;padding:4px;vertical-align:middle;color:#334155;word-break:keep-all}.exec-table tr:nth-child(even){background-color:#f8fafc!important}</style></head><body>${content}<script>const noPrint=document.querySelectorAll('.no-print');noPrint.forEach(e=>e.remove());const gCvs=document.getElementById('execGradeChart');if(gCvs&&'${gUrl}'){const i=document.createElement('img');i.src='${gUrl}';i.className='printed-chart-img';gCvs.parentNode.appendChild(i);gCvs.remove()}const fCvs=document.getElementById('execFactorChart');if(fCvs&&'${fUrl}'){const i=document.createElement('img');i.src='${fUrl}';i.className='printed-chart-img';fCvs.parentNode.appendChild(i);fCvs.remove()}setTimeout(()=>{window.print();window.close()},800);<\/script></body></html>`);w.document.close()};

document.addEventListener('DOMContentLoaded',()=>{updateStoredCount();const ua=navigator.userAgent.toLowerCase();if(/kakaotalk|line|instagram|fbav/i.test(ua)){if(/android/i.test(ua))location.href='intent://'+location.href.replace(/https?:\/\//i,'')+'#Intent;scheme=http;package=com.android.chrome;end';document.getElementById('kakaotalk-guide').style.display='flex'}});</script></body></html>
